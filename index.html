<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Manager</title>
    <!-- Include Chart.js and jsPDF libraries from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- Global Styles & Resets --- */
        :root {
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --background-color: #f4f4f9;
            --text-color: #333;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --green: #2d9a47;
            --yellow: #ffb703;
            --red: #d00000;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .hidden {
            display: none !important;
        }
        
        /* --- Role-Based Visibility --- */
        .role-salesRep .profit-display,
        .role-manager .profit-display {
            display: none !important;
        }
        
        .role-salesRep .manager-only,
        .role-salesRep .admin-only {
            display: none !important;
        }
        
        .role-manager .admin-only {
            display: none !important;
        }


        /* --- Login Screen --- */
        #loginScreen {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        #loginScreen h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        #loginForm .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        #loginForm label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        #loginForm input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        #loginError {
            color: var(--red);
            margin-top: 10px;
            font-size: 14px;
            height: 1.2em;
        }
        .login-button {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .login-button:hover {
            background-color: var(--secondary-color);
        }

        /* --- Main App Container --- */
        #appContainer {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .main-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .main-header h1 {
            font-size: 24px;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #currentUserDisplay {
            font-style: italic;
        }
        
        #menuToggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        #logoutButton {
            background: var(--red);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* --- Main Content & Pages --- */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .page {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Dropdown Menu --- */
        #mainMenu {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1000;
            overflow: hidden;
            min-width: 250px;
        }
        #mainMenu a {
            display: block;
            padding: 12px 25px;
            color: var(--primary-color);
            text-decoration: none;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        #mainMenu a:last-child {
            border-bottom: none;
        }
        #mainMenu a:hover {
            background-color: #f0f8ff;
        }
        
        /* --- General UI Components --- */
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid var(--secondary-color);
        }
        .stat-card h3 { font-size: 16px; color: #666; margin-bottom: 10px; }
        .stat-card p { font-size: 28px; font-weight: bold; color: var(--primary-color); }
        .stat-card.profit { border-color: var(--green); }
        .stat-card.profit p { color: var(--green); }
        .stat-card.loss { border-color: var(--red); }
        .stat-card.loss p { color: var(--red); }
        
        .main-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .main-button:hover { background-color: var(--secondary-color); }
        .main-button:disabled { background-color: #ccc; cursor: not-allowed; }

        .action-button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            margin-right: 5px;
        }
        .edit-btn { background-color: var(--secondary-color); }
        .delete-btn { background-color: var(--red); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); }
        th { background-color: #f8f9fa; font-weight: bold; }
        tr:hover { background-color: #f1f1f1; }

        .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-bar input, .filter-bar select, .filter-bar button, .filter-bar label { padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); }
        .filter-bar label { border: none; padding: 10px 0; }
        .filter-bar button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; }

        /* --- Point of Sale (POS) / Cart Page --- */
        #posPage {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: calc(100vh - 110px); /* Full height minus header and padding */
        }
        .pos-panel { display: flex; flex-direction: column; background: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; }
        .pos-panel-header { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .pos-panel-body { flex-grow: 1; overflow-y: auto; padding: 10px; }
        #productCatalog { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .product-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .product-card.disabled { opacity: 0.5; cursor: not-allowed; background: #f9f9f9; }
        .product-card-name { font-weight: bold; }
        .product-card-price { color: var(--green); }
        .product-card-stock { font-size: 12px; color: #777; }
        #cartItems { list-style: none; }
        .cart-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .cart-item-name { flex-grow: 1; }
        .cart-item-qty { display: flex; align-items: center; gap: 8px; }
        .cart-item-qty button { width: 25px; height: 25px; border-radius: 50%; border: 1px solid var(--border-color); background: white; cursor: pointer; }
        .cart-item-total { font-weight: bold; width: 80px; text-align: right; }
        .cart-item-remove { background: none; border: none; color: var(--red); font-size: 18px; cursor: pointer; }
        .cart-footer { padding: 15px; border-top: 1px solid var(--border-color); margin-top: auto; }
        .cart-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        .cart-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 900px) {
            #posPage { grid-template-columns: 1fr; height: auto; }
        }

        /* --- Modal Styles --- */
        .modal {
            position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background-color: rgba(0,0,0,0.6); /* Darker overlay for receipt */
        }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; color: #888; }
        .modal-form .form-group { margin-bottom: 15px; }
        .modal-form label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-form input, .modal-form select, .modal-form textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .salary-field { position: relative; }
        .toggle-salary-visibility { position: absolute; right: 10px; top: 38px; cursor: pointer; user-select: none;}
        
        /* --- NEW: Redesigned Receipt Ticket Styles --- */
        #receiptModal .modal-content {
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
            overflow: visible;
            max-width: none;
            width: 100%;
        }

        #receiptModal .modal-close {
            color: white; /* Make close button visible on dark overlay */
            text-shadow: 0 1px 2px black;
        }

        .receipt-ticket {
            width: 100%;
            max-width: 380px; /* A good width for ticket-style receipts */
            background: #fff;
            margin: 20px auto;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-family: 'Courier New', Courier, monospace; /* Classic receipt font */
            color: #222;
        }

        .receipt-ticket-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .receipt-ticket-header h2 {
            font-size: 24px;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }
        .receipt-ticket-header p {
            font-size: 12px;
            color: #555;
            margin: 5px 0 0;
        }

        .receipt-ticket-info p {
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .receipt-ticket-info p span {
            font-weight: bold;
        }

        .receipt-separator {
            border-top: 2px dashed #888;
            margin: 15px 0;
        }

        .receipt-ticket-items table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .receipt-ticket-items th {
            text-align: left;
            padding-bottom: 8px;
            border-bottom: 1px solid #555;
            font-weight: bold;
        }
        .receipt-ticket-items td {
            padding: 8px 2px;
            vertical-align: top;
        }
        .receipt-ticket-items .item-name {
            font-weight: normal;
        }
        .receipt-ticket-items .item-details {
            display: block;
            font-size: 11px;
            color: #666;
        }
        .receipt-ticket-items .text-right {
            text-align: right;
        }
        
        .receipt-ticket-totals {
            margin-top: 15px;
            font-size: 14px;
        }
        .receipt-ticket-totals p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .receipt-ticket-totals p.total {
            font-size: 20px;
            font-weight: bold;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #555;
        }

        .receipt-ticket-footer {
            text-align: center;
            margin-top: 20px;
        }
        .receipt-ticket-footer p {
            font-size: 12px;
            color: #555;
            margin-bottom: 10px;
        }
        .barcode {
            width: 80%;
            height: 40px;
            margin: 0 auto;
            background-image: linear-gradient(to right, 
                #333 1px, transparent 1px, transparent 2px, 
                #333 2px, #333 4px, transparent 4px, transparent 6px,
                #333 6px, #333 7px, transparent 7px, transparent 10px,
                #333 10px, #333 11px, transparent 11px, transparent 12px,
                #333 12px, #333 15px, transparent 15px, transparent 16px,
                #333 16px, #333 19px, transparent 19px, transparent 20px
            );
            background-repeat: repeat-x;
        }

        .receipt-buttons { text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center;}
        
        /* --- Performance Popup Modal --- */
        #performanceReportModal .modal-content h3 { color: var(--primary-color); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        #performanceReportModal .modal-content ul { list-style-position: inside; padding-left: 10px; margin-bottom: 20px; }
        #performanceReportModal .modal-content li { margin-bottom: 8px; }
        #performanceReportModal .modal-content li span { font-weight: bold; }

        /* --- UPDATED PRINT STYLES --- */
        @media print {
            body * { visibility: hidden; }
            body { background: #fff; /* Ensure a white background for printing */ }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: static;
                display: flex;
                justify-content: center; /* Center the receipt horizontally */
                align-items: flex-start; /* Align to the top of the page */
                width: 100%;
                height: 100%;
                padding-top: 2cm; /* Add some top margin */
            }
            #receiptModal {
                position: static;
                background: none;
                overflow: visible;
            }
            .receipt-ticket {
                box-shadow: none;
                margin: 0;
                border: 1px solid #ccc; /* Optional: add a border for cutting */
            }
            .modal-close, .receipt-buttons { display: none; }
        }
    </style>
</head>
<body>

    <!-- ======== LOGIN SCREEN ======== -->
    <div id="loginScreen">
        <h1>Business Manager</h1>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <p id="loginError"></p>
            <button type="submit" class="login-button">Login</button>
        </form>
    </div>

    <!-- ======== MAIN APPLICATION ======== -->
    <div id="appContainer" class="hidden">
        <!-- Header -->
        <header class="main-header">
            <h1>Business Manager</h1>
            <div class="header-controls">
                <span id="currentUserDisplay"></span>
                <button id="logoutButton">Logout</button>
                <button id="menuToggle">☰</button>
            </div>
        </header>

        <!-- Dropdown Menu -->
        <div id="mainMenu" class="hidden">
            <!-- Links are dynamically populated by JS -->
        </div>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- PAGE: Overview -->
            <div id="overviewPage" class="page">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <h2 id="overviewTitle">Dashboard Overview</h2>
                        <p style="font-size: 14px; color: #666;">Showing stats since: <span id="statsStartDateDisplay">the beginning</span>.</p>
                    </div>
                    <button id="toggleStatsPeriodBtn" class="main-button manager-only">Start New Period</button>
                </div>
                <div class="overview-grid">
                    <div class="stat-card"><h3>Total Goods in Stock</h3><p id="totalStockCount">0</p></div>
                    <div class="stat-card"><h3 id="totalSoldCountHeader">Total Units Sold</h3><p id="totalSoldCount">0</p></div>
                    <div class="stat-card"><h3 id="totalSalesValueHeader">Total Sales Value</h3><p id="totalSalesValue">₦0</p></div>
                    <div class="stat-card profit profit-display" id="cumulativeProfitCard"><h3 id="cumulativeProfitHeader">Cumulative Net Profit</h3><p id="cumulativeProfit">₦0</p></div>
                </div>
                
                <!-- NEW: Low Stock Ticker -->
                <div class="card hidden" id="lowStockTicker" style="margin-top: 20px; padding: 10px 20px; background-color: #fff3cd; border-left: 5px solid var(--yellow);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 24px;">⚠️</span>
                        <div style="font-weight: bold; flex-shrink: 0;">Low Stock Alert:</div>
                        <marquee behavior="scroll" direction="left" id="lowStockMarquee" style="width: 100%;"></marquee>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>Monthly Performance</h3>
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <!-- PAGE: Point of Sale (POS) -->
            <div id="posPage" class="page hidden">
                <div class="pos-panel">
                    <div class="pos-panel-header">
                        <input type="text" id="posProductSearch" placeholder="Search products..." style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color);">
                    </div>
                    <div class="pos-panel-body" id="productCatalog">
                        <!-- Product cards will be injected here -->
                    </div>
                </div>
                <div class="pos-panel">
                    <div class="pos-panel-header"><h3>Current Sale</h3></div>
                    <div class="pos-panel-body">
                        <ul id="cartItems">
                            <!-- Cart items will be injected here -->
                        </ul>
                    </div>
                    <div class="cart-footer">
                        <div class="cart-total">
                            <span>TOTAL</span>
                            <span id="cartTotalDisplay">₦0.00</span>
                        </div>
                        <div class="cart-actions">
                            <button id="clearCartBtn" class="action-button delete-btn">Clear Cart</button>
                            <button id="finalizeSaleBtn" class="main-button" disabled>Finalize Sale</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: Product Management -->
            <div id="productManagementPage" class="page hidden">
                <h2>Product Management</h2>
                <button id="addProductBtn" class="main-button">Add New Product</button>
                <div class="filter-bar"><input type="text" id="productSearchInput" placeholder="Search by product name..."></div>
                <div style="overflow-x:auto;"><table id="productTable">
                    <thead><tr><th>Name</th><th>Category</th><th>Buying Price</th><th>Selling Price</th><th>In Stock</th><th>Sold</th><th>Supplier</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </div>

            <!-- PAGE: Sales Log -->
            <div id="salesLogPage" class="page hidden">
                <h2>Sales Log</h2>
                <div class="filter-bar">
                    <input type="text" id="salesLogSearchInput" placeholder="Search by Invoice # or Customer...">
                    <input type="date" id="salesLogDateFilter">
                    <button onclick="renderSalesLog()">Filter</button>
                    <button id="submitMySalesBtn" class="main-button" onclick="submitMySales()" disabled>Submit My Sales</button>
                </div>
                <div style="overflow-x:auto;"><table id="salesLogTable">
                    <thead></thead>
                    <tbody></tbody>
                </table></div>
            </div>

            <!-- PAGE: Stock Level Monitoring -->
            <div id="stockLevelPage" class="page hidden">
                <h2>Stock Level Monitoring</h2>
                <div style="overflow-x:auto;"><table id="stockLevelTable">
                    <thead><tr><th>Status</th><th>Product Name</th><th>Qty in Stock</th><th>Low Stock Threshold</th><th>Stock Level</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </div>

            <!-- PAGE: P&L Tracker -->
            <div id="plTrackerPage" class="page hidden">
                <h2>Profit and Loss Tracker</h2>
                <div class="filter-bar"><label>Select Month:</label><input type="month" id="plMonthFilter"><button onclick="renderPLTracker()">View Report</button></div>
                <div class="overview-grid">
                    <div class="stat-card"><h3>Total Revenue</h3><p id="plTotalRevenue">₦0</p></div>
                    <div class="stat-card"><h3>Cost of Goods Sold</h3><p id="plTotalCost">₦0</p></div>
                    <div class="stat-card"><h3>Operating Expenses</h3><p id="plTotalExpenses">₦0</p></div>
                    <div class="stat-card profit profit-display" id="plNetProfitCard"><h3>Net Profit/Loss</h3><p id="plNetProfit">₦0</p></div>
                </div>
            </div>

            <!-- PAGE: Purchase History Log -->
            <div id="purchaseHistoryPage" class="page hidden">
                <h2>Purchase History Log</h2>
                <div class="filter-bar">
                    <label for="purchaseStartDate">From:</label><input type="date" id="purchaseStartDate">
                    <label for="purchaseEndDate">To:</label><input type="date" id="purchaseEndDate">
                    <button onclick="renderPurchaseHistory()">Filter</button>
                    <button id="downloadPurchasePdfBtn" class="main-button">Download as PDF</button>
                    <button id="downloadPurchaseCsvBtn" class="main-button">Download as CSV</button>
                </div>
                <div style="overflow-x:auto;"><table id="purchaseHistoryTable">
                    <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Cost/Item</th><th>Total Cost</th><th>Supplier</th><th>Payment</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </div>
            
            <!-- PAGE: Expenses Manager -->
            <div id="expensesManagerPage" class="page hidden">
                <h2>Monthly Expenses Manager</h2>
                <button id="addExpenseBtn" class="main-button">Add New Expense</button>
                <div style="overflow-x:auto;"><table id="expensesTable">
                    <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </div>

            <!-- PAGE: Capital Tracker (Admin Only) -->
            <div id="capitalTrackerPage" class="page hidden admin-only">
                <h2>Capital Tracker</h2>
                <button id="addCapitalTransactionBtn" class="main-button">Add Capital Transaction</button>
                <div class="overview-grid" style="margin-top: 20px;">
                    <div class="stat-card"><h3>Initial Capital</h3><p id="initialCapitalDisplay">₦0</p></div>
                    <div class="stat-card profit"><h3>Total Injections</h3><p id="totalInjectionsDisplay">₦0</p></div>
                    <div class="stat-card loss"><h3>Total Withdrawals</h3><p id="totalWithdrawalsDisplay">₦0</p></div>
                    <div class="stat-card profit"><h3>Current Capital</h3><p id="currentCapitalDisplay">₦0</p></div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h3>Transaction History</h3>
                    <div style="overflow-x:auto;"><table id="capitalHistoryTable">
                        <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Notes</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table></div>
                </div>
            </div>
            
            <!-- PAGE: Reports & Analytics -->
            <div id="reportsPage" class="page hidden">
                <h2>Reports & Analytics</h2>
                <div class="card">
                    <h3>Generate Monthly Report</h3>
                    <div class="filter-bar"><label>Select Month:</label><input type="month" id="reportMonthSelector"><button id="generateReportBtn" class="main-button">Generate & Download</button></div>
                    <p>Select a month to generate a comprehensive PDF report including Sales, Purchases, Expenses, and Profitability.</p>
                </div>
            </div>
            
            <!-- PAGE: User Management (Admin Only) -->
            <div id="userManagementPage" class="page hidden admin-only">
                <h2>User Management</h2>
                <button id="addUserBtn" class="main-button">Add New User</button>
                <div style="overflow-x:auto;"><table id="userTable">
                    <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </div>

            <!-- PAGE: User Settings -->
            <div id="userSettingsPage" class="page hidden">
                <h2>User Settings</h2>
                <div class="card">
                    <h3>Change Your Password</h3>
                    <form id="changePasswordForm" class="modal-form">
                        <div class="form-group"><label for="currentPassword">Current Password</label><input type="password" id="currentPassword" required></div>
                        <div class="form-group"><label for="newPassword">New Password</label><input type="password" id="newPassword" minlength="4" required></div>
                        <div class="form-group"><label for="confirmNewPassword">Confirm New Password</label><input type="password" id="confirmNewPassword" required></div>
                        <button type="submit" class="main-button">Change Password</button>
                        <p id="passwordChangeStatus" style="margin-top:10px;"></p>
                    </form>
                </div>
                <!-- Backup and Restore Card -->
                <div class="card" style="margin-top: 20px;">
                    <h3>Data Management</h3>
                    <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                        Backup your data to a file for safekeeping, or restore from a previously saved backup file. 
                        <strong>Warning:</strong> Restoring will overwrite all current data.
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="backupDataBtn" class="main-button">Download Backup File</button>
                        <div class="form-group" style="display:flex; align-items:center; gap: 10px; margin-bottom: 0;">
                             <input type="file" id="restoreDataInput" accept=".json">
                             <button id="restoreDataBtn" class="action-button delete-btn">Restore from File</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        <div><h5>Developed By Charleytech Hub: 09068420849</h5></div>
    </div>

    <!-- ======== MODALS ======== -->

    <!-- Product Modal -->
    <div id="productModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('productModal')">&times;</span><h2 id="productModalTitle">Add Product</h2><form id="productForm" class="modal-form"><input type="hidden" id="productId"><div class="form-group"><label for="productName">Product Name</label><input type="text" id="productName" required></div><div class="form-group"><label for="productCategory">Category</label><input type="text" id="productCategory" required></div><div class="form-group"><label for="buyingPrice">Buying Price (₦)</label><input type="number" id="buyingPrice" min="0" step="0.01" required></div><div class="form-group"><label for="sellingPrice">Selling Price (₦)</label><input type="number" id="sellingPrice" min="0" step="0.01" required></div><div class="form-group"><label for="quantityInStock">Quantity In Stock</label><input type="number" id="quantityInStock" min="0" required></div><div class="form-group"><label for="lowStockThreshold">Low Stock Alert Level</label><input type="number" id="lowStockThreshold" min="0" value="10"></div><div class="form-group"><label for="supplierInfo">Supplier</label><input type="text" id="supplierInfo"></div><div class="form-group" id="purchaseDetailsGroup"><label for="purchaseDate">Date of Purchase</label><input type="date" id="purchaseDate" required><label for="purchasePaymentMode" style="margin-top:10px;">Payment Mode</label><select id="purchasePaymentMode"><option value="Cash">Cash</option><option value="Transfer">Bank Transfer</option><option value="POS">POS</option></select></div><button type="submit" class="main-button">Save Product</button></form></div></div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('expenseModal')">&times;</span><h2 id="expenseModalTitle">Add Expense</h2><form id="expenseForm" class="modal-form"><input type="hidden" id="expenseId"><div class="form-group"><label for="expenseDate">Date</label><input type="date" id="expenseDate" required></div><div class="form-group"><label for="expenseCategory">Category</label><select id="expenseCategory" required><option value="Rent">Rent</option><option value="Utilities">Utilities (Light, Water)</option><option value="Salaries">Salaries</option><option value="Transport">Transport/Logistics</option><option value="Maintenance">Maintenance</option><option value="Miscellaneous">Miscellaneous</option></select></div><div class="form-group"><label for="expenseDescription">Description</label><input type="text" id="expenseDescription" placeholder="e.g. 'January Electricity Bill'"></div><div class="form-group salary-field"><label for="expenseAmount">Amount (₦)</label><input type="password" id="expenseAmount" min="0" step="0.01" required><span class="toggle-salary-visibility" onclick="toggleSalaryVisibility(this)">👁️</span></div><button type="submit" class="main-button">Save Expense</button></form></div></div>
    
    <!-- Capital Modal -->
    <div id="capitalModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('capitalModal')">&times;</span><h2 id="capitalModalTitle">Add Capital Transaction</h2><form id="capitalForm" class="modal-form"><input type="hidden" id="capitalTransactionId"><div class="form-group"><label for="capitalDate">Date</label><input type="date" id="capitalDate" required></div><div class="form-group"><label for="capitalType">Transaction Type</label><select id="capitalType" required><option value="injection">Capital Injection</option><option value="withdrawal">Capital Withdrawal</option><option value="initial">Set/Update Initial Capital</option></select></div><div class="form-group"><label for="capitalAmount">Amount (₦)</label><input type="number" id="capitalAmount" min="0" step="0.01" required></div><div class="form-group"><label for="capitalNotes">Notes (Optional)</label><textarea id="capitalNotes" rows="3"></textarea></div><button type="submit" class="main-button">Save Transaction</button></form></div></div>

    <!-- User Modal (for Add/Edit) -->
    <div id="userModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('userModal')">&times;</span><h2 id="userModalTitle">Add User</h2><form id="userForm" class="modal-form"><input type="hidden" id="userId"><div class="form-group"><label for="userUsername">Username</label><input type="text" id="userUsername" required></div><div class="form-group"><label for="userPassword">Password</label><input type="password" id="userPassword" minlength="4" required></div><div class="form-group"><label for="userRole">Role</label><select id="userRole" required><option value="salesRep">Sales Rep</option><option value="manager">Manager</option><option value="auditor">Auditor</option><option value="admin">Admin</option></select></div><button type="submit" class="main-button">Save User</button></form></div></div>
    
    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('checkoutModal')">&times;</span><h2>Finalize Sale</h2><form id="checkoutForm" class="modal-form"><div class="form-group"><label for="customerName">Customer Name (Optional)</label><input type="text" id="customerName" placeholder="Walk-in Customer"></div><button type="submit" class="main-button">Complete Sale & Get Receipt</button></form></div></div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal hidden">
        <div class="modal-content">
            <div id="print-area">
                <!-- Receipt content is injected here by JS -->
                <div id="receiptContainer"></div>
            </div>
            <div class="receipt-buttons">
                <button class="main-button" onclick="printReceipt()">Print Receipt</button>
                <button class="action-button delete-btn" onclick="closeModal('receiptModal')">Close</button>
            </div>
            <span class="modal-close" onclick="closeModal('receiptModal')">&times;</span>
        </div>
    </div>
    
    <!-- Performance Pop-up Modal -->
    <div id="performanceReportModal" class="modal hidden">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('performanceReportModal')">&times;</span>
            <h2>Product Performance Highlights</h2>
            <div id="performanceReportContent">
                <!-- Content generated by JS -->
            </div>
        </div>
    </div>


<script>
// --- Polyfill for structuredClone ---
if (!window.structuredClone) {
    window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));
}

document.addEventListener('DOMContentLoaded', () => {

    // =================================================================
    // =========== STATE MANAGEMENT (DATABASE) & INITIALIZATION ========
    // =================================================================
    let db;
    let currentUser = null;
    let trendsChart = null;
    let salesCart = [];
    let sessionPopupsShown = false;
    const DB_KEY = 'angelaStoresDB_v5';

    const DEFAULT_DB = {
        users: [],
        products: [],
        sales: [],
        purchases: [],
        expenses: [],
        capital: {
            initial: 0,
            transactions: [],
        },
        statsStartDate: null,
    };

    function loadDatabase() {
        try {
            const data = localStorage.getItem(DB_KEY);
            db = data ? JSON.parse(data) : structuredClone(DEFAULT_DB);
        } catch (error) {
            console.error("Error parsing database from localStorage, resetting to default.", error);
            db = structuredClone(DEFAULT_DB);
        }
        
        for (const key in DEFAULT_DB) {
            if (!db.hasOwnProperty(key)) {
                 db[key] = structuredClone(DEFAULT_DB[key]);
            }
        }
        if (!db.capital || typeof db.capital !== 'object') {
            db.capital = structuredClone(DEFAULT_DB.capital);
        }
        if (!db.hasOwnProperty('statsStartDate')) {
            db.statsStartDate = null;
        }

        if (db.users.length === 0) {
            db.users.push({ id: generateId(), username: 'admin', password: 'password', role: 'admin' });
            db.users.push({ id: generateId(), username: 'manager', password: 'password', role: 'manager' });
            db.users.push({ id: generateId(), username: 'sales', password: 'password', role: 'salesRep' });
            saveDatabase();
        }
    }

    function saveDatabase() {
        // This function acts as the "auto-save" by writing to persistent storage.
        localStorage.setItem(DB_KEY, JSON.stringify(db));
    }


    // =================================================================
    // ======================= AUTHENTICATION ==========================
    // =================================================================
    
    document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('loginError');

        const user = db.users.find(u => u.username === username && u.password === password);

        if (user) {
            login(user);
            loginError.textContent = '';
        } else {
            loginError.textContent = 'Invalid username or password.';
        }
    });

    function login(user) {
        currentUser = user;
        sessionPopupsShown = false; 
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');
        document.getElementById('loginForm').reset();
        
        setupUIForRole();
        renderAll();

        if (['admin', 'manager'].includes(currentUser.role)) {
            showPerformancePopups();
        }
    }

    function logout() {
        currentUser = null;
        salesCart = [];
        const appContainer = document.getElementById('appContainer');
        appContainer.classList.remove('role-admin', 'role-manager', 'role-salesRep', 'role-auditor');
        document.getElementById('loginScreen').classList.remove('hidden');
        appContainer.classList.add('hidden');
        document.getElementById('mainMenu').classList.add('hidden');
    }

    // =================================================================
    // ====================== UI & NAVIGATION ==========================
    // =================================================================
    
    function setupUIForRole() {
        document.getElementById('currentUserDisplay').textContent = `User: ${currentUser.username} (${currentUser.role})`;
        
        // Add role class to the container for CSS-based visibility
        const appContainer = document.getElementById('appContainer');
        appContainer.classList.remove('role-admin', 'role-manager', 'role-salesRep', 'role-auditor');
        appContainer.classList.add(`role-${currentUser.role}`);
        
        const menuItems = {
            'Dashboard': { page: 'overviewPage', roles: ['admin', 'manager', 'auditor'] },
            'Point of Sale': { page: 'posPage', roles: ['admin', 'manager', 'salesRep'] },
            'Sales Log': { page: 'salesLogPage', roles: ['admin', 'manager', 'salesRep', 'auditor'] },
            'Product Management': { page: 'productManagementPage', roles: ['admin', 'manager'] },
            'Stock Monitoring': { page: 'stockLevelPage', roles: ['admin', 'manager', 'salesRep', 'auditor'] },
            'P&L Tracker': { page: 'plTrackerPage', roles: ['admin', 'manager', 'auditor'] },
            'Purchase History': { page: 'purchaseHistoryPage', roles: ['admin', 'manager', 'auditor'] },
            'Expenses': { page: 'expensesManagerPage', roles: ['admin', 'manager'] },
            'Capital Tracker': { page: 'capitalTrackerPage', roles: ['admin'] },
            'User Management': { page: 'userManagementPage', roles: ['admin'] },
            'Reports': { page: 'reportsPage', roles: ['admin', 'manager', 'auditor'] },
            'Settings': { page: 'userSettingsPage', roles: ['admin', 'manager', 'salesRep', 'auditor'] },
        };

        const menuContainer = document.getElementById('mainMenu');
        menuContainer.innerHTML = '';
        Object.entries(menuItems).forEach(([title, item]) => {
            if (item.roles.includes(currentUser.role)) {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = title;
                link.dataset.page = item.page;
                link.classList.add('menu-link');
                menuContainer.appendChild(link);
            }
        });
        
        const defaultPage = currentUser.role === 'salesRep' ? 'posPage' : 'overviewPage';
        showPage(defaultPage);
    }
    
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
        const pageToShow = document.getElementById(pageId);
        if (pageToShow) {
            pageToShow.classList.remove('hidden');
        }
        document.getElementById('mainMenu').classList.add('hidden');

        if (pageId === 'posPage') renderPosPage();
    }
    
    document.getElementById('mainMenu').addEventListener('click', (e) => {
        if (e.target.classList.contains('menu-link')) {
            e.preventDefault();
            showPage(e.target.dataset.page);
        }
    });
    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('mainMenu').classList.toggle('hidden');
    });
    document.getElementById('logoutButton').addEventListener('click', logout);
    
    window.showModal = function(modalId) { document.getElementById(modalId).classList.remove('hidden'); }
    window.closeModal = function(modalId) { document.getElementById(modalId).classList.add('hidden'); }
    
    // =================================================================
    // ===================== UI RENDERING FUNCTIONS ====================
    // =================================================================

    function formatNaira(amount) {
        return `₦${Number(amount).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    
    function renderAll() {
        renderOverview();
        renderProductManagement();
        renderSalesLog();
        renderStockLevels();
        renderPLTracker();
        renderPurchaseHistory();
        renderExpenses();
        if (currentUser.role === 'admin') {
            renderCapitalTracker();
            renderUserManagement();
        }
    }
    
    function renderOverview() {
        const startDate = db.statsStartDate;
        const statsBtn = document.getElementById('toggleStatsPeriodBtn');
        const startDateDisplay = document.getElementById('statsStartDateDisplay');
        const overviewTitle = document.getElementById('overviewTitle');
        const soldCountHeader = document.getElementById('totalSoldCountHeader');
        const salesValueHeader = document.getElementById('totalSalesValueHeader');
        const profitHeader = document.getElementById('cumulativeProfitHeader');

        let filteredSales = db.sales;
        let filteredExpenses = db.expenses;
        
        if (startDate) {
            filteredSales = db.sales.filter(s => new Date(s.dateTime) >= new Date(startDate));
            filteredExpenses = db.expenses.filter(e => new Date(e.date) >= new Date(startDate));
            statsBtn.textContent = 'Show All-Time Stats';
            startDateDisplay.textContent = ` ${new Date(startDate).toLocaleDateString()}`;
            overviewTitle.textContent = "Current Period Overview";
            soldCountHeader.textContent = "Units Sold (Period)";
            salesValueHeader.textContent = "Sales Value (Period)";
            profitHeader.textContent = "Net Profit (Period)";
        } else {
            statsBtn.textContent = 'Start New Period';
            startDateDisplay.textContent = 'the beginning';
            overviewTitle.textContent = "Dashboard Overview";
            soldCountHeader.textContent = "Total Units Sold";
            salesValueHeader.textContent = "Total Sales Value";
            profitHeader.textContent = "Cumulative Net Profit";
        }
        
        let totalStock = db.products.reduce((sum, p) => sum + p.quantityInStock, 0);
        let totalSoldUnits = filteredSales.reduce((sum, s) => sum + s.items.reduce((itemSum, i) => itemSum + i.quantity, 0), 0);
        let totalSalesValue = filteredSales.reduce((sum, s) => sum + s.grandTotal, 0);
        
        document.getElementById('totalStockCount').textContent = totalStock.toLocaleString();
        document.getElementById('totalSoldCount').textContent = totalSoldUnits.toLocaleString();
        document.getElementById('totalSalesValue').textContent = formatNaira(totalSalesValue);

        if (!['salesRep', 'manager'].includes(currentUser.role)) {
            const totalCostOfGoodsSold = filteredSales.reduce((sum, s) => sum + s.items.reduce((itemSum, i) => itemSum + (i.buyingPrice * i.quantity), 0), 0);
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            let periodProfit = totalSalesValue - totalCostOfGoodsSold - totalExpenses;
            
            const profitDisplay = document.getElementById('cumulativeProfit');
            const profitCard = document.getElementById('cumulativeProfitCard');
            profitDisplay.textContent = formatNaira(periodProfit);
            profitCard.classList.toggle('loss', periodProfit < 0);
            profitCard.classList.toggle('profit', periodProfit >= 0);
        }

        renderTrendsChart();
        renderLowStockTicker(); // Render the new ticker
    }

    function renderTrendsChart() {
        const ctx = document.getElementById('trendsChart').getContext('2d');
        const salesByMonth = {};
        const profitByMonth = {};
        
        db.sales.forEach(s => { 
            const month = s.date.substring(0, 7); 
            salesByMonth[month] = (salesByMonth[month] || 0) + s.grandTotal; 
            profitByMonth[month] = (profitByMonth[month] || 0) + s.totalProfit;
        });
        db.expenses.forEach(e => { 
            const month = e.date.substring(0, 7); 
            profitByMonth[month] = (profitByMonth[month] || 0) - e.amount;
        });

        const labels = [...new Set([...Object.keys(salesByMonth), ...Object.keys(profitByMonth)])].sort();
        const salesData = labels.map(label => salesByMonth[label] || 0);
        
        let datasets = [
            { type: 'bar', label: 'Monthly Sales', data: salesData, backgroundColor: 'rgba(10, 147, 150, 0.6)', yAxisID: 'y' }
        ];

        // Only add profit data for admin and auditor roles
        if (!['salesRep', 'manager'].includes(currentUser.role)) {
            const profitData = labels.map(label => profitByMonth[label] || 0);
            datasets.unshift({ type: 'line', label: 'Monthly Net Profit', data: profitData, borderColor: 'var(--green)', tension: 0.1, yAxisID: 'y1' });
        }
        
        const scales = { y: { beginAtZero: true, position: 'left' } };
        if (!['salesRep', 'manager'].includes(currentUser.role)) {
             scales.y1 = { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } };
        }

        if (trendsChart) trendsChart.destroy();
        trendsChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: { scales }
        });
    }

    window.renderSalesLog = function() {
        const table = document.getElementById('salesLogTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        // Define headers based on role
        const showProfit = !['salesRep', 'manager'].includes(currentUser.role);
        let headers = ['Invoice #', 'Date & Time', 'Items', 'Total'];
        if (showProfit) headers.push('Profit');
        headers.push('Customer', 'Sold By', 'Status', 'Actions');

        thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        
        const searchTerm = document.getElementById('salesLogSearchInput').value.toLowerCase();
        const dateFilter = document.getElementById('salesLogDateFilter').value;

        let filteredSales = db.sales.filter(s => 
            (!searchTerm || s.invoiceNumber.toLowerCase().includes(searchTerm) || (s.customerName && s.customerName.toLowerCase().includes(searchTerm))) &&
            (!dateFilter || s.date === dateFilter)
        );

        filteredSales.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)).forEach(s => {
            const seller = db.users.find(u => u.id === s.userId);
            const statusHtml = s.submitted 
                ? `<span style="color:var(--green); font-weight:bold;">✔ Submitted</span>` 
                : `<span style="color:var(--yellow); font-weight:bold;">Pending</span>`;
            
            let rowHtml = `
                <td>${s.invoiceNumber}</td>
                <td>${new Date(s.dateTime).toLocaleString()}</td>
                <td>${s.items.length}</td>
                <td>${formatNaira(s.grandTotal)}</td>
            `;
            if (showProfit) {
                rowHtml += `<td>${formatNaira(s.totalProfit)}</td>`;
            }
            rowHtml += `
                <td>${s.customerName}</td>
                <td>${seller ? seller.username : 'N/A'}</td>
                <td>${statusHtml}</td>
                <td>
                    <button class="action-button edit-btn" onclick="printMultiItemReceipt('${s.invoiceNumber}')">Receipt</button>
                    ${(currentUser.role === 'admin' || (currentUser.role === 'manager' && !s.submitted)) ? `<button class="action-button delete-btn" onclick="deleteSale('${s.invoiceNumber}')">Delete</button>` : ''}
                </td>
            `;
            tbody.innerHTML += `<tr>${rowHtml}</tr>`;
        });

        const pendingSalesForCurrentUser = db.sales.some(s => s.userId === currentUser.id && !s.submitted);
        document.getElementById('submitMySalesBtn').disabled = !pendingSalesForCurrentUser;
    }

    window.renderPLTracker = function() {
        const selectedMonth = document.getElementById('plMonthFilter').value || new Date().toISOString().slice(0, 7);
        if (!document.getElementById('plMonthFilter').value) {
            document.getElementById('plMonthFilter').value = selectedMonth;
        }
        
        const salesInPeriod = db.sales.filter(s => s.date.startsWith(selectedMonth));
        const expensesInPeriod = db.expenses.filter(e => e.date.startsWith(selectedMonth));

        let revenue = salesInPeriod.reduce((sum, s) => sum + s.grandTotal, 0);
        let costOfGoods = salesInPeriod.reduce((sum, s) => sum + s.items.reduce((itemSum, i) => itemSum + (i.buyingPrice * i.quantity), 0), 0);
        let totalExpenses = expensesInPeriod.reduce((sum, e) => sum + e.amount, 0);
        
        document.getElementById('plTotalRevenue').textContent = formatNaira(revenue);
        document.getElementById('plTotalCost').textContent = formatNaira(costOfGoods);
        document.getElementById('plTotalExpenses').textContent = formatNaira(totalExpenses);
        
        if (!['salesRep', 'manager'].includes(currentUser.role)) {
            const netProfit = revenue - costOfGoods - totalExpenses;
            const netProfitDisplay = document.getElementById('plNetProfit');
            const netProfitCard = document.getElementById('plNetProfitCard');
            netProfitDisplay.textContent = formatNaira(netProfit);
            netProfitCard.classList.remove('profit', 'loss');
            netProfitCard.classList.add(netProfit >= 0 ? 'profit' : 'loss');
        }
    }

    window.renderPurchaseHistory = function() {
        const tbody = document.getElementById('purchaseHistoryTable').querySelector('tbody');
        tbody.innerHTML = '';
        const startDate = document.getElementById('purchaseStartDate').value;
        const endDate = document.getElementById('purchaseEndDate').value;

        let filteredPurchases = db.purchases.filter(p => {
            if (startDate && p.date < startDate) return false;
            if (endDate && p.date > endDate) return false;
            return true;
        });

        filteredPurchases.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(p => {
            const product = db.products.find(prod => prod.id === p.productId);
            tbody.innerHTML += `
                <tr>
                    <td>${p.date}</td>
                    <td>${product ? product.name : 'N/A (Deleted)'}</td>
                    <td>${p.quantity}</td>
                    <td>${formatNaira(p.costPerItem)}</td>
                    <td>${formatNaira(p.totalCost)}</td>
                    <td>${p.supplier}</td>
                    <td>${p.paymentMode}</td>
                </tr>
            `;
        });
    }
    
    function renderExpenses() {
        const tbody = document.getElementById('expensesTable').querySelector('tbody');
        tbody.innerHTML = '';
        db.expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(e => {
            tbody.innerHTML += `
                <tr>
                    <td>${e.date}</td>
                    <td>${e.category}</td>
                    <td>${e.description}</td>
                    <td>${formatNaira(e.amount)}</td>
                    <td>
                        <button class="action-button edit-btn" onclick="editExpense('${e.id}')">Edit</button>
                        <button class="action-button delete-btn" onclick="deleteExpense('${e.id}')">Delete</button>
                    </td>
                </tr>
            `;
        });
    }
    
    function renderCapitalTracker() {
        const initialCapital = db.capital.initial;
        const totalInjections = db.capital.transactions
            .filter(t => t.type === 'injection')
            .reduce((sum, t) => sum + t.amount, 0);
        const totalWithdrawals = db.capital.transactions
            .filter(t => t.type === 'withdrawal')
            .reduce((sum, t) => sum + t.amount, 0);
        const currentCapital = initialCapital + totalInjections - totalWithdrawals;

        document.getElementById('initialCapitalDisplay').textContent = formatNaira(initialCapital);
        document.getElementById('totalInjectionsDisplay').textContent = formatNaira(totalInjections);
        document.getElementById('totalWithdrawalsDisplay').textContent = formatNaira(totalWithdrawals);
        document.getElementById('currentCapitalDisplay').textContent = formatNaira(currentCapital);

        const tbody = document.getElementById('capitalHistoryTable').querySelector('tbody');
        tbody.innerHTML = '';
        db.capital.transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(t => {
            tbody.innerHTML += `
                <tr>
                    <td>${t.date}</td>
                    <td style="text-transform: capitalize;">${t.type}</td>
                    <td style="color:${t.type === 'withdrawal' ? 'var(--red)' : 'var(--green)'}; font-weight: bold;">${t.type === 'withdrawal' ? '-' : '+'}${formatNaira(t.amount)}</td>
                    <td>${t.notes || 'N/A'}</td>
                    <td><button class="action-button delete-btn" onclick="deleteCapitalTransaction('${t.id}')">Delete</button></td>
                </tr>
            `;
        });
    }

    // =================================================================
    // ====================== POINT OF SALE (CART) =====================
    // =================================================================
    
    function renderPosPage() {
        renderProductCatalog();
        renderCart();
    }

    function renderProductCatalog() {
        const catalog = document.getElementById('productCatalog');
        const searchTerm = document.getElementById('posProductSearch').value.toLowerCase();
        catalog.innerHTML = '';
        db.products
            .filter(p => p.name.toLowerCase().includes(searchTerm))
            .sort((a,b) => a.name.localeCompare(b.name))
            .forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.productId = p.id;
                if (p.quantityInStock <= 0) card.classList.add('disabled');
                card.innerHTML = `
                    <div class="product-card-name">${p.name}</div>
                    <div class="product-card-price">${formatNaira(p.sellingPrice)}</div>
                    <div class="product-card-stock">Stock: ${p.quantityInStock}</div>
                `;
                catalog.appendChild(card);
            });
    }
    
    function renderCart() {
        const cartItemsList = document.getElementById('cartItems');
        cartItemsList.innerHTML = '';
        let total = 0;
        if (salesCart.length === 0) {
            cartItemsList.innerHTML = '<p style="text-align:center; color:#888; padding: 20px;">Cart is empty</p>';
        } else {
            salesCart.forEach(item => {
                const li = document.createElement('li');
                li.className = 'cart-item';
                const itemTotal = item.sellingPrice * item.quantity;
                total += itemTotal;
                li.innerHTML = `
                    <span class="cart-item-name">${item.name}</span>
                    <div class="cart-item-qty">
                        <button onclick="updateCartQuantity('${item.id}', ${item.quantity - 1})">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="updateCartQuantity('${item.id}', ${item.quantity + 1})">+</button>
                    </div>
                    <span class="cart-item-total">${formatNaira(itemTotal)}</span>
                    <button class="cart-item-remove" onclick="removeFromCart('${item.id}')">&times;</button>
                `;
                cartItemsList.appendChild(li);
            });
        }
        document.getElementById('cartTotalDisplay').textContent = formatNaira(total);
        document.getElementById('finalizeSaleBtn').disabled = salesCart.length === 0;
    }

    function addToCart(productId) {
        const product = db.products.find(p => p.id === productId);
        if (!product || product.quantityInStock <= 0) return;

        const cartItem = salesCart.find(item => item.id === productId);
        if (cartItem) {
            if (cartItem.quantity < product.quantityInStock) {
                cartItem.quantity++;
            } else {
                alert('Maximum stock for this item reached.');
            }
        } else {
            salesCart.push({
                id: product.id, name: product.name,
                sellingPrice: product.sellingPrice, buyingPrice: product.buyingPrice,
                quantity: 1
            });
        }
        renderCart();
    }

    window.updateCartQuantity = function(productId, newQuantity) {
        const cartItem = salesCart.find(item => item.id === productId);
        const product = db.products.find(p => p.id === productId);
        if (!cartItem || !product) return;
        
        if (newQuantity <= 0) {
            removeFromCart(productId);
        } else if (newQuantity > product.quantityInStock) {
            alert('Cannot add more than available in stock.');
            cartItem.quantity = product.quantityInStock;
        } else {
            cartItem.quantity = newQuantity;
        }
        renderCart();
    }

    window.removeFromCart = function(productId) {
        salesCart = salesCart.filter(item => item.id !== productId);
        renderCart();
    }

    function clearCart() {
        salesCart = [];
        renderCart();
    }

    function finalizeSale() {
        const customerName = document.getElementById('customerName').value || 'Walk-in Customer';
        const now = new Date();
        
        const saleRecord = {
            invoiceNumber: `INV-${Date.now()}`,
            date: now.toISOString().split('T')[0],
            dateTime: now.toISOString(),
            userId: currentUser.id,
            customerName: customerName,
            submitted: false, 
            items: structuredClone(salesCart.map(item => ({
                productId: item.id, productName: item.name,
                quantity: item.quantity, sellingPrice: item.sellingPrice,
                buyingPrice: item.buyingPrice,
            }))),
            grandTotal: salesCart.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0),
            totalProfit: salesCart.reduce((sum, item) => sum + ((item.sellingPrice - item.buyingPrice) * item.quantity), 0),
        };

        saleRecord.items.forEach(item => {
            const product = db.products.find(p => p.id === item.productId);
            if (product) {
                product.quantityInStock -= item.quantity;
                product.quantitySold = (product.quantitySold || 0) + item.quantity;
            }
        });

        db.sales.push(saleRecord);
        saveDatabase();
        
        clearCart();
        closeModal('checkoutModal');
        renderAll();
        showPage('posPage');
        printMultiItemReceipt(saleRecord.invoiceNumber);
    }

    document.getElementById('productCatalog').addEventListener('click', (e) => {
        const card = e.target.closest('.product-card');
        if (card && !card.classList.contains('disabled')) {
            addToCart(card.dataset.productId);
        }
    });
    document.getElementById('posProductSearch').addEventListener('input', renderProductCatalog);
    document.getElementById('clearCartBtn').addEventListener('click', clearCart);
    document.getElementById('finalizeSaleBtn').addEventListener('click', () => {
        document.getElementById('checkoutForm').reset();
        showModal('checkoutModal');
    });
    document.getElementById('checkoutForm').addEventListener('submit', (e) => {
        e.preventDefault();
        finalizeSale();
    });

    // =================================================================
    // =========== RECEIPT, PRINTING, DELETION, & SUBMISSION ===========
    // =================================================================

    window.submitMySales = function() {
        const salesToSubmit = db.sales.filter(s => s.userId === currentUser.id && !s.submitted);
        if (salesToSubmit.length === 0) {
            alert('You have no pending sales to submit.');
            return;
        }

        const totalProfitToSubmit = salesToSubmit.reduce((sum, s) => sum + s.totalProfit, 0);
        let confirmationMessage = '';
        
        // Admins and auditors see the financial impact.
        if (['admin', 'auditor'].includes(currentUser.role)) {
            confirmationMessage = `You are about to submit a total profit of ${formatNaira(totalProfitToSubmit)} from ${salesToSubmit.length} sale(s). This will be added to the company capital. This action cannot be undone.\n\nDo you want to proceed?`;
        } else {
            // Sales Reps and Managers only see the number of sales, not the value.
            confirmationMessage = `You are about to submit ${salesToSubmit.length} pending sale(s). This action cannot be undone.\n\nDo you want to proceed?`;
        }
        
        if (confirm(confirmationMessage)) {
            // The profit is calculated and added regardless of the message shown.
            db.capital.transactions.push({
                id: generateId(),
                date: new Date().toISOString().split('T')[0],
                type: 'injection',
                amount: totalProfitToSubmit,
                notes: `Profit deposit from sales by ${currentUser.username}`
            });

            salesToSubmit.forEach(sale => {
                const saleInDb = db.sales.find(s => s.invoiceNumber === sale.invoiceNumber);
                if (saleInDb) {
                    saleInDb.submitted = true;
                }
            });

            saveDatabase();
            alert('Sales submitted successfully!');
            renderAll();
        }
    }

    // UPDATED: Function to generate the new receipt design
    window.printMultiItemReceipt = function(invoiceNumber) {
        const sale = db.sales.find(s => s.invoiceNumber === invoiceNumber);
        if (!sale) return;
        const seller = db.users.find(u => u.id === sale.userId);

        const receiptContainer = document.getElementById('receiptContainer');
        
        let itemsHtml = '';
        sale.items.forEach(item => {
            itemsHtml += `
                <tr>
                    <td class="item-name">
                        ${item.productName}
                        <span class="item-details">${item.quantity} x ${formatNaira(item.sellingPrice)}</span>
                    </td>
                    <td class="text-right">${formatNaira(item.sellingPrice * item.quantity)}</td>
                </tr>
            `;
        });
        
        receiptContainer.innerHTML = `
            <div class="receipt-ticket">
                <div class="receipt-ticket-header">
                    <h2>Official Receipt</h2>
                </div>
                <div class="receipt-ticket-info">
                    <p>Invoice #: <span>${sale.invoiceNumber}</span></p>
                    <p>Date: <span>${new Date(sale.dateTime).toLocaleString()}</span></p>
                    <p>Cashier: <span>${seller ? seller.username : 'N/A'}</span></p>
                    <p>Customer: <span>${sale.customerName}</span></p>
                </div>
                <div class="receipt-separator"></div>
                <div class="receipt-ticket-items">
                    <table>
                        <thead>
                            <tr>
                                <th>ITEM</th>
                                <th class="text-right">TOTAL</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                </div>
                <div class="receipt-separator"></div>
                <div class="receipt-ticket-totals">
                    <p><span>Subtotal</span> <span class="text-right">${formatNaira(sale.grandTotal)}</span></p>
                    <p><span>Discount</span> <span class="text-right">₦0.00</span></p>
                    <p class="total"><span>TOTAL</span> <span class="text-right">${formatNaira(sale.grandTotal)}</span></p>
                </div>
                <div class="receipt-ticket-footer">
                    <p>Thank you for your patronage!</p>
                    <div class="barcode"></div>
                </div>
            </div>
        `;
        showModal('receiptModal');
    }
    
    window.printReceipt = function() {
        window.print();
    }

    window.deleteSale = function(invoiceNumber) {
        const saleIndex = db.sales.findIndex(s => s.invoiceNumber === invoiceNumber);
        if (saleIndex === -1) {
            console.error("Sale not found for deletion:", invoiceNumber);
            return;
        }

        const sale = db.sales[saleIndex];
        let confirmationMessage = '';
        let isSubmittedReversal = false;

        if (sale.submitted && currentUser.role === 'admin') {
            // Admin deleting a submitted sale (refund/reversal case)
            confirmationMessage = `ADMIN ACTION:\nThis sale has been submitted and its profit (${formatNaira(sale.totalProfit)}) was added to capital.\n\nDeleting this will REVERSE the transaction by creating a capital withdrawal and returning stock.\n\nThis is for handling refunds or corrections. Are you sure you want to proceed?`;
            isSubmittedReversal = true;
        } else if (sale.submitted) {
            // Non-admin trying to delete a submitted sale
            alert('This sale has already been submitted and cannot be deleted. Please contact an administrator for assistance with returns or refunds.');
            return;
        } else {
            // Deleting a pending sale
            confirmationMessage = 'Are you sure you want to delete this pending sale? The stock will be returned to inventory. This action cannot be undone.';
        }

        if (confirm(confirmationMessage)) {
            // Action confirmed, proceed with deletion logic

            // 1. Return stock to inventory (common for both cases)
            sale.items.forEach(item => {
                const product = db.products.find(p => p.id === item.productId);
                if (product) {
                    product.quantityInStock += item.quantity;
                    product.quantitySold -= item.quantity;
                }
            });

            // 2. Handle capital reversal if it was a submitted sale
            if (isSubmittedReversal) {
                db.capital.transactions.push({
                    id: generateId(),
                    date: new Date().toISOString().split('T')[0],
                    type: 'withdrawal',
                    amount: sale.totalProfit,
                    notes: `Reversal/Refund for submitted Invoice #${sale.invoiceNumber}`
                });
            }

            // 3. Remove the sale record
            db.sales.splice(saleIndex, 1);

            // 4. Save and re-render
            saveDatabase();
            alert('Sale has been successfully deleted.');
            renderAll();
        }
    }
    
    // =================================================================
    // ================ PERFORMANCE POPUPS & OTHER MGMT ================
    // =================================================================
    
    // Function to render the low stock scrolling ticker
    function renderLowStockTicker() {
        const tickerContainer = document.getElementById('lowStockTicker');
        const marqueeEl = document.getElementById('lowStockMarquee');
        
        const lowStockProducts = db.products.filter(p => p.quantityInStock > 0 && p.quantityInStock <= p.lowStockThreshold);
        const outOfStockProducts = db.products.filter(p => p.quantityInStock <= 0);
        
        const allAlerts = [...outOfStockProducts, ...lowStockProducts]; // Show out of stock first
        
        if (allAlerts.length > 0) {
            const message = allAlerts.map(p => {
                if (p.quantityInStock <= 0) {
                    return `${p.name} (Out of Stock)`;
                } else {
                    return `${p.name} (${p.quantityInStock} left)`;
                }
            }).join(' &nbsp; | &nbsp; '); // Using &nbsp; for spacing inside marquee

            marqueeEl.innerHTML = message;
            tickerContainer.classList.remove('hidden');
        } else {
            tickerContainer.classList.add('hidden');
        }
    }

    function toggleStatsPeriod() {
        if (db.statsStartDate) {
            db.statsStartDate = null;
            saveDatabase();
            renderOverview();
            alert("Dashboard now showing all-time statistics.");
        } else {
            const confirmation = confirm("Are you sure you want to start a new reporting period?\n\nThis will reset the main dashboard stats, tracking new totals from this moment forward.\n\nAll historical data remains safe and accessible in reports.");
            if (confirmation) {
                db.statsStartDate = new Date().toISOString();
                saveDatabase();
                renderOverview();
                alert("Dashboard stats have been reset for the new period.");
            }
        }
    }

    function showPerformancePopups() {
        if (sessionPopupsShown) return;

        const soldProducts = db.products.filter(p => p.quantitySold > 0);
        const unsoldProducts = db.products.filter(p => (p.quantitySold || 0) === 0 && p.quantityInStock > 0);

        if (soldProducts.length === 0 && unsoldProducts.length === 0) return;

        soldProducts.sort((a, b) => b.quantitySold - a.quantitySold);
        
        let bestSellersHtml = '<h3>⭐ Top Selling Products</h3>';
        if (soldProducts.length > 0) {
            bestSellersHtml += '<ul>';
            soldProducts.slice(0, 3).forEach(p => {
                bestSellersHtml += `<li><span>${p.name}</span> - ${p.quantitySold} units sold</li>`;
            });
            bestSellersHtml += '</ul>';
        } else {
            bestSellersHtml += '<p>No products have been sold yet.</p>';
        }

        let lowPerformersHtml = '<h3>⚠️ Products to Review (Low Sales)</h3>';
        if (unsoldProducts.length > 0) {
            lowPerformersHtml += '<ul>';
            unsoldProducts.slice(0, 5).forEach(p => {
                lowPerformersHtml += `<li><span>${p.name}</span> - 0 units sold</li>`;
            });
            lowPerformersHtml += '</ul>';
        } else {
            lowPerformersHtml += '<p>All products have at least one sale. Great job!</p>';
        }

        document.getElementById('performanceReportContent').innerHTML = bestSellersHtml + lowPerformersHtml;
        showModal('performanceReportModal');
        sessionPopupsShown = true;
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }
    
    function renderProductManagement() {
        const tbody = document.getElementById('productTable').querySelector('tbody');
        tbody.innerHTML = '';
        const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
        db.products.filter(p => p.name.toLowerCase().includes(searchTerm)).forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.name}</td><td>${p.category}</td><td>${formatNaira(p.buyingPrice)}</td>
                    <td>${formatNaira(p.sellingPrice)}</td><td>${p.quantityInStock}</td><td>${p.quantitySold || 0}</td>
                    <td>${p.supplier || 'N/A'}</td>
                    <td>
                        <button class="action-button edit-btn" onclick="editProduct('${p.id}')">Edit</button>
                        <button class="action-button delete-btn" onclick="deleteProduct('${p.id}')">Delete</button>
                    </td>
                </tr>
            `;
        });
    }
    document.getElementById('productSearchInput').addEventListener('input', renderProductManagement);
    document.getElementById('addProductBtn').addEventListener('click', () => {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('productModalTitle').textContent = 'Add New Product';
        document.getElementById('purchaseDetailsGroup').style.display = 'block';
        document.getElementById('purchaseDate').valueAsDate = new Date();
        showModal('productModal');
    });

    window.editProduct = function(id) {
        const p = db.products.find(p => p.id === id);
        if (!p) return;
        document.getElementById('productId').value = p.id;
        document.getElementById('productName').value = p.name;
        document.getElementById('productCategory').value = p.category;
        document.getElementById('buyingPrice').value = p.buyingPrice;
        document.getElementById('sellingPrice').value = p.sellingPrice;
        document.getElementById('quantityInStock').value = p.quantityInStock;
        document.getElementById('lowStockThreshold').value = p.lowStockThreshold || 10;
        document.getElementById('supplierInfo').value = p.supplier;
        document.getElementById('productModalTitle').textContent = 'Edit Product';
        document.getElementById('purchaseDetailsGroup').style.display = 'none';
        showModal('productModal');
    }
    
    document.getElementById('productForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('productId').value;
        const productData = {
            name: document.getElementById('productName').value, category: document.getElementById('productCategory').value,
            buyingPrice: parseFloat(document.getElementById('buyingPrice').value), sellingPrice: parseFloat(document.getElementById('sellingPrice').value),
            quantityInStock: parseInt(document.getElementById('quantityInStock').value), supplier: document.getElementById('supplierInfo').value,
            lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value),
        };
        if (id) {
            const index = db.products.findIndex(p => p.id === id);
            if (index !== -1) {
                db.products[index] = {...db.products[index], ...productData};
            }
        } else {
            productData.id = generateId(); productData.quantitySold = 0;
            db.products.push(productData);
            db.purchases.push({
                id: generateId(), productId: productData.id, date: document.getElementById('purchaseDate').value,
                quantity: productData.quantityInStock, costPerItem: productData.buyingPrice,
                totalCost: productData.buyingPrice * productData.quantityInStock, supplier: productData.supplier,
                paymentMode: document.getElementById('purchasePaymentMode').value,
            });
        }
        saveDatabase(); renderAll(); closeModal('productModal');
    });

    window.deleteProduct = function(id) {
        if (confirm('Are you sure you want to delete this product? All associated purchase and sales records will remain, but the link will be broken.')) {
            db.products = db.products.filter(p => p.id !== id);
            saveDatabase(); renderAll();
        }
    }

    function renderStockLevels() {
        const tbody = document.getElementById('stockLevelTable').querySelector('tbody');
        tbody.innerHTML = '';
        db.products.forEach(p => {
            const threshold = p.lowStockThreshold || 10;
            let statusText, statusColor;
            if (p.quantityInStock <= 0) {
                statusText = 'Out of Stock'; statusColor = 'var(--red)';
            } else if (p.quantityInStock <= threshold) {
                statusText = 'Low Stock'; statusColor = 'var(--yellow)';
            } else {
                statusText = 'In Stock'; statusColor = 'var(--green)';
            }

            const totalStockEver = p.quantityInStock + (p.quantitySold || 0);
            const stockPercent = totalStockEver > 0 ? (p.quantityInStock / totalStockEver) * 100 : 0;
            const stockLevelBar = `<div style="width: 100%; background: #eee; border-radius: 5px; overflow:hidden;"><div style="width: ${stockPercent}%; height: 10px; background: ${statusColor};"></div></div>`;

            tbody.innerHTML += `
                <tr>
                    <td><span style="color:${statusColor}; font-weight: bold;">${statusText}</span></td>
                    <td>${p.name}</td><td>${p.quantityInStock}</td>
                    <td>${threshold}</td><td>${stockLevelBar}</td>
                </tr>`;
        });
    }

    document.getElementById('addExpenseBtn').addEventListener('click', () => {
        document.getElementById('expenseForm').reset();
        document.getElementById('expenseId').value = '';
        document.getElementById('expenseModalTitle').textContent = 'Add New Expense';
        document.getElementById('expenseDate').valueAsDate = new Date();
        showModal('expenseModal');
    });
    
    window.editExpense = function(id) {
        const expense = db.expenses.find(e => e.id === id);
        if (!expense) return;
        document.getElementById('expenseId').value = expense.id;
        document.getElementById('expenseDate').value = expense.date;
        document.getElementById('expenseCategory').value = expense.category;
        document.getElementById('expenseDescription').value = expense.description;
        document.getElementById('expenseAmount').value = expense.amount;
        document.getElementById('expenseModalTitle').textContent = 'Edit Expense';
        showModal('expenseModal');
    }

    document.getElementById('expenseForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('expenseId').value;
        const expenseData = {
            date: document.getElementById('expenseDate').value,
            category: document.getElementById('expenseCategory').value,
            description: document.getElementById('expenseDescription').value,
            amount: parseFloat(document.getElementById('expenseAmount').value),
        };
        if (id) {
            const index = db.expenses.findIndex(exp => exp.id === id);
            db.expenses[index] = { ...db.expenses[index], ...expenseData };
        } else {
            expenseData.id = generateId();
            db.expenses.push(expenseData);
        }
        saveDatabase(); renderAll(); closeModal('expenseModal');
    });

    window.deleteExpense = function(id) {
        if (confirm('Are you sure you want to delete this expense record?')) {
            db.expenses = db.expenses.filter(e => e.id !== id);
            saveDatabase(); renderAll();
        }
    }
    window.toggleSalaryVisibility = function(element) { const input = element.previousElementSibling; input.type = input.type === 'password' ? 'text' : 'password'; element.textContent = input.type === 'password' ? '👁️' : '🙈'; }

    document.getElementById('addCapitalTransactionBtn').addEventListener('click', () => {
        document.getElementById('capitalForm').reset();
        document.getElementById('capitalTransactionId').value = '';
        document.getElementById('capitalDate').valueAsDate = new Date();
        document.getElementById('capitalModalTitle').textContent = 'Add Capital Transaction';
        showModal('capitalModal');
    });

    document.getElementById('capitalForm').addEventListener('submit', e => {
        e.preventDefault();
        const type = document.getElementById('capitalType').value;
        const amount = parseFloat(document.getElementById('capitalAmount').value);

        if (type === 'initial') {
            db.capital.initial = amount;
        } else {
            db.capital.transactions.push({
                id: generateId(), date: document.getElementById('capitalDate').value,
                type: type, amount: amount,
                notes: document.getElementById('capitalNotes').value,
            });
        }
        saveDatabase(); renderCapitalTracker(); closeModal('capitalModal');
    });

    window.deleteCapitalTransaction = function(id) {
        if(confirm('Are you sure you want to delete this capital transaction?')) {
            db.capital.transactions = db.capital.transactions.filter(t => t.id !== id);
            saveDatabase(); renderCapitalTracker();
        }
    }
    
    function renderUserManagement() {
        const tbody = document.getElementById('userTable').querySelector('tbody');
        tbody.innerHTML = '';
        db.users.forEach(user => {
            tbody.innerHTML += `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>
                        <button class="action-button edit-btn" onclick="editUser('${user.id}')">Edit</button>
                        ${user.id !== currentUser.id ? `<button class="action-button delete-btn" onclick="deleteUser('${user.id}')">Delete</button>` : ''}
                    </td>
                </tr>
            `;
        });
    }

    document.getElementById('addUserBtn').addEventListener('click', () => {
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('userModalTitle').textContent = 'Add New User';
        document.getElementById('userPassword').required = true;
        document.getElementById('userPassword').placeholder = "At least 4 characters";
        showModal('userModal');
    });

    window.editUser = function(id) {
        const user = db.users.find(u => u.id === id);
        if (!user) return;
        document.getElementById('userId').value = user.id;
        document.getElementById('userUsername').value = user.username;
        document.getElementById('userRole').value = user.role;
        document.getElementById('userPassword').value = '';
        document.getElementById('userPassword').placeholder = "Enter new password (optional)";
        document.getElementById('userPassword').required = false;
        document.getElementById('userModalTitle').textContent = 'Edit User';
        showModal('userModal');
    }

    document.getElementById('userForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('userId').value;
        const username = document.getElementById('userUsername').value;
        const password = document.getElementById('userPassword').value;
        const role = document.getElementById('userRole').value;

        if (id) {
            const user = db.users.find(u => u.id === id);
            user.username = username; user.role = role;
            if (password) user.password = password;
        } else {
            if (db.users.some(u => u.username === username)) {
                alert('Username already exists.'); return;
            }
            db.users.push({ id: generateId(), username, password, role });
        }
        saveDatabase(); renderUserManagement(); closeModal('userModal');
    });

    window.deleteUser = function(id) {
        if(confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            db.users = db.users.filter(u => u.id !== id);
            saveDatabase(); renderUserManagement();
        }
    }

    document.getElementById('changePasswordForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        const statusEl = document.getElementById('passwordChangeStatus');

        if (currentUser.password !== currentPassword) {
            statusEl.textContent = 'Current password is incorrect.'; statusEl.style.color = 'red'; return;
        }
        if (newPassword !== confirmNewPassword) {
            statusEl.textContent = 'New passwords do not match.'; statusEl.style.color = 'red'; return;
        }

        currentUser.password = newPassword;
        const userInDb = db.users.find(u => u.id === currentUser.id);
        if(userInDb) userInDb.password = newPassword;
        
        saveDatabase();
        statusEl.textContent = 'Password changed successfully!'; statusEl.style.color = 'green';
        e.target.reset();
        setTimeout(() => statusEl.textContent = '', 3000);
    });
    
    // =================================================================
    // =========== DATA BACKUP & RESTORE / PDF & CSV DOWNLOAD ==========
    // =================================================================

    // Function to handle data backup to a JSON file
    function backupData() {
        try {
            const dataStr = JSON.stringify(db, null, 2); // Pretty-print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `BusinessManager_Backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Backup file has been downloaded successfully!');
        } catch (error) {
            console.error('Failed to create backup:', error);
            alert('An error occurred while creating the backup file.');
        }
    }

    // Function to handle data restore from a JSON file
    function restoreData() {
        const fileInput = document.getElementById('restoreDataInput');
        const file = fileInput.files[0];

        if (!file) {
            alert('Please select a backup file to restore.');
            return;
        }
        
        const confirmation = confirm(
            'WARNING: This will completely overwrite all existing data in the application with the contents of the selected file.\n\n' +
            'This action CANNOT be undone.\n\n' +
            'Are you absolutely sure you want to proceed?'
        );

        if (!confirmation) {
            fileInput.value = ''; // Clear the file input
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const restoredDb = JSON.parse(event.target.result);
                
                // Basic validation to ensure it's a valid DB structure
                if (restoredDb && restoredDb.users && restoredDb.products && restoredDb.sales) {
                    db = restoredDb;
                    saveDatabase(); // Persist the restored data
                    alert('Data restored successfully. You will now be logged out to apply the changes.');
                    logout(); // Force logout to re-initialize state safely
                } else {
                    throw new Error('Invalid backup file structure.');
                }
            } catch (error) {
                console.error('Failed to restore data:', error);
                alert('Error: The selected file is not a valid backup file or is corrupted.');
            } finally {
                fileInput.value = ''; // Clear the file input
            }
        };
        
        reader.onerror = function() {
            alert('An error occurred while reading the file.');
            fileInput.value = ''; // Clear the file input
        };

        reader.readAsText(file);
    }

    const pdfStyles = {
        headStyles: { fillColor: [0, 95, 115], textColor: [255, 255, 255], fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [244, 244, 249] },
        styles: { cellPadding: 3, fontSize: 9, cellWidth: 'wrap' },
        columnStyles: { 0: { cellWidth: 'auto' }, 2: { cellWidth: 'auto' } }
    };

    document.getElementById('downloadPurchasePdfBtn').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        doc.setFontSize(18);
        doc.setTextColor(0, 95, 115);
        doc.text("Purchase History Report", 14, 16);
        const tableData = db.purchases.map(p => {
            const product = db.products.find(prod => prod.id === p.productId);
            return [ p.date, product ? product.name : 'N/A (Deleted)', p.quantity, formatNaira(p.costPerItem), formatNaira(p.totalCost), p.supplier, p.paymentMode ];
        });
        doc.autoTable({ head: [['Date', 'Product', 'Qty', 'Cost/Item', 'Total Cost', 'Supplier', 'Payment']], body: tableData, startY: 25, ...pdfStyles });
        doc.save('BusinessManager_PurchaseHistory.pdf');
    });

    document.getElementById('downloadPurchaseCsvBtn').addEventListener('click', () => {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Date,Product,Quantity,Cost per Item,Total Cost,Supplier,Payment Mode\r\n";
        db.purchases.forEach(p => {
            const product = db.products.find(prod => prod.id === p.productId);
            const row = [ p.date, `"${(product ? product.name : 'N/A (Deleted)').replace(/"/g, '""')}"`, p.quantity, p.costPerItem, p.totalCost, `"${(p.supplier || '').replace(/"/g, '""')}"`, p.paymentMode ].join(",");
            csvContent += row + "\r\n";
        });
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", "BusinessManager_PurchaseHistory.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    document.getElementById('generateReportBtn').addEventListener('click', () => {
        const selectedMonth = document.getElementById('reportMonthSelector').value;
        if (!selectedMonth) { alert('Please select a month to generate a report.'); return; }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        const monthDate = new Date(`${selectedMonth}-02`);
        const monthName = monthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        
        const salesInPeriod = db.sales.filter(s => s.date.startsWith(selectedMonth));
        const purchasesInPeriod = db.purchases.filter(p => p.date.startsWith(selectedMonth));
        const expensesInPeriod = db.expenses.filter(e => e.date.startsWith(selectedMonth));

        doc.setFontSize(22); doc.setTextColor(0, 95, 115); doc.text(`Monthly Report for ${monthName}`, 14, 20);
        
        // --- Conditional Summary for PDF based on role ---
        const showProfit = !['salesRep', 'manager'].includes(currentUser.role);
        const revenue = salesInPeriod.reduce((sum, s) => sum + s.grandTotal, 0);
        const cogs = salesInPeriod.reduce((sum, s) => sum + s.items.reduce((itemSum, i) => itemSum + (i.buyingPrice * i.quantity), 0), 0);
        const expenses = expensesInPeriod.reduce((sum, e) => sum + e.amount, 0);
        let summaryBody = [
            ['Total Revenue (Sales)', formatNaira(revenue)],
            ['Cost of Goods Sold (COGS)', formatNaira(cogs)],
            ['Operating Expenses', formatNaira(expenses)],
        ];
        if (showProfit) {
            const netProfit = revenue - cogs - expenses;
            summaryBody.splice(2, 0, ['Gross Profit (Revenue - COGS)', formatNaira(revenue - cogs)]);
            summaryBody.push([{ content: 'Net Profit / Loss', styles: { fontStyle: 'bold' } }, { content: formatNaira(netProfit), styles: { fontStyle: 'bold', textColor: netProfit >= 0 ? [45, 154, 71] : [208, 0, 0] } }]);
        }
        doc.autoTable({ startY: 30, theme: 'plain', body: summaryBody, styles: { fontSize: 12, cellPadding: 4 }, columnStyles: { 0: { fontStyle: 'bold' } } });
        
        if (salesInPeriod.length > 0) {
            doc.addPage(); doc.setFontSize(18); doc.setTextColor(0, 95, 115); doc.text(`Sales Details - ${monthName}`, 14, 20);
            
            let salesHead = [['Invoice #', 'Date & Time', 'Customer', 'Items', 'Total']];
            if(showProfit) salesHead[0].push('Profit');

            const salesData = salesInPeriod.map(s => {
                let row = [s.invoiceNumber, new Date(s.dateTime).toLocaleString(), s.customerName, s.items.length, formatNaira(s.grandTotal)];
                if(showProfit) row.push(formatNaira(s.totalProfit));
                return row;
            });
            doc.autoTable({ head: salesHead, body: salesData, startY: 25, ...pdfStyles });
        }

        if (purchasesInPeriod.length > 0) {
            doc.addPage(); doc.setFontSize(18); doc.setTextColor(0, 95, 115); doc.text(`Purchase Details - ${monthName}`, 14, 20);
            const purchaseData = purchasesInPeriod.map(p => {
                const product = db.products.find(prod => prod.id === p.productId);
                return [p.date, product ? product.name : 'N/A', p.quantity, formatNaira(p.costPerItem), formatNaira(p.totalCost), p.supplier];
            });
            doc.autoTable({ head: [['Date', 'Product', 'Qty', 'Cost/Item', 'Total Cost', 'Supplier']], body: purchaseData, startY: 25, ...pdfStyles });
        }
        if (expensesInPeriod.length > 0) {
            doc.addPage(); doc.setFontSize(18); doc.setTextColor(0, 95, 115); doc.text(`Expense Details - ${monthName}`, 14, 20);
            const expenseData = expensesInPeriod.map(e => [e.date, e.category, e.description, formatNaira(e.amount)]);
            doc.autoTable({ head: [['Date', 'Category', 'Description', 'Amount']], body: expenseData, startY: 25, ...pdfStyles });
        }
        doc.save(`BusinessManager_Report_${selectedMonth}.pdf`);
    });

    // =================================================================
    // ===================== APPLICATION STARTUP =======================
    // =================================================================
    document.getElementById('toggleStatsPeriodBtn').addEventListener('click', toggleStatsPeriod);
    
    // Add event listeners for backup and restore
    document.getElementById('backupDataBtn').addEventListener('click', backupData);
    document.getElementById('restoreDataBtn').addEventListener('click', restoreData);

    loadDatabase();
    
});
</script>

</body>


</html>
