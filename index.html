<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Manager</title>
    <!-- Include Chart.js and jsPDF libraries from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- Global Styles & Resets --- */
        :root {
            --primary-color: #005f73;
            --secondary-color: #0a9396;
            --background-color: #f4f4f9;
            --text-color: #333;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --green: #2d9a47;
            --yellow: #ffb703;
            --red: #d00000;
            --blue: #0077b6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--background-color); color: var(--text-color); display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* --- Role-Based Visibility --- */
        .role-salesRep .profit-display, .role-manager .profit-display { display: none !important; }
        .role-salesRep .manager-only, .role-salesRep .admin-only { display: none !important; }
        .role-manager .admin-only { display: none !important; }

        /* --- Login Screen --- */
        #loginScreen { background: var(--card-bg); padding: 40px; border-radius: 12px; box-shadow: var(--shadow); text-align: center; width: 90%; max-width: 400px; }
        #loginScreen h1 { color: var(--primary-color); margin-bottom: 20px; }
        #loginForm .form-group { margin-bottom: 15px; text-align: left; }
        #loginForm label { display: block; margin-bottom: 5px; font-weight: bold; }
        #loginForm input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; }
        #loginError { color: var(--red); margin-top: 10px; font-size: 14px; height: 1.2em; }
        .login-button { width: 100%; padding: 15px; margin-top: 10px; font-size: 16px; font-weight: bold; color: white; background-color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; }
        .login-button:hover { background-color: var(--secondary-color); }

        /* --- Main App Container --- */
        #appContainer { width: 100%; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .main-header { background-color: var(--primary-color); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .main-header h1 { font-size: 24px; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        #currentUserDisplay { font-style: italic; }
        #menuToggle { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        #logoutButton { background: var(--red); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .main-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .page { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dropdown Menu --- */
        #mainMenu { position: absolute; top: 60px; right: 20px; background-color: white; border-radius: 8px; box-shadow: var(--shadow); z-index: 1000; overflow: hidden; min-width: 250px; }
        #mainMenu a { display: block; padding: 12px 25px; color: var(--primary-color); text-decoration: none; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        #mainMenu a:last-child { border-bottom: none; }
        #mainMenu a:hover { background-color: #f0f8ff; }
        
        /* --- General UI Components --- */
        .card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { background-color: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid var(--secondary-color); position: relative; }
        .stat-card h3 { font-size: 16px; color: #666; margin-bottom: 10px; }
        .stat-card p { font-size: 28px; font-weight: bold; color: var(--primary-color); }
        .stat-card.profit { border-color: var(--green); }
        .stat-card.profit p { color: var(--green); }
        .stat-card.capital { border-color: var(--blue); }
        .stat-card.capital p { color: var(--blue); }
        .stat-card-action { position: absolute; bottom: 5px; right: 5px; }
        .stat-card-action button { font-size: 11px; padding: 3px 8px; }
        .main-button { background-color: var(--primary-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        .main-button:hover { background-color: var(--secondary-color); }
        .main-button:disabled { background-color: #ccc; cursor: not-allowed; }
        .action-button { padding: 5px 10px; border: none; border-radius: 5px; color: white; cursor: pointer; margin-right: 5px; }
        .edit-btn { background-color: var(--secondary-color); }
        .delete-btn { background-color: var(--red); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border-color); }
        th { background-color: #f8f9fa; font-weight: bold; }
        tr:hover { background-color: #f1f1f1; }
        .text-credit { color: var(--green); font-weight: bold; }
        .text-debit { color: var(--red); font-weight: bold; }
        .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-bar input, .filter-bar select, .filter-bar button, .filter-bar label { padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); }
        .filter-bar label { border: none; padding: 10px 0; }
        .filter-bar button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; }

        /* --- Point of Sale (POS) --- */
        #posPage { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: calc(100vh - 110px); }
        .pos-panel { display: flex; flex-direction: column; background: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; }
        .pos-panel-header { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .pos-panel-body { flex-grow: 1; overflow-y: auto; padding: 10px; }
        #productCatalog { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .product-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .product-card.disabled { opacity: 0.5; cursor: not-allowed; background: #f9f9f9; }
        .product-card-name { font-weight: bold; }
        .product-card-price { color: var(--green); }
        .product-card-stock { font-size: 12px; color: #777; }
        #cartItems { list-style: none; }
        .cart-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
        .cart-item-name { flex-grow: 1; }
        .cart-item-qty { display: flex; align-items: center; gap: 8px; }
        .cart-item-qty button { width: 25px; height: 25px; border-radius: 50%; border: 1px solid var(--border-color); background: white; cursor: pointer; }
        .cart-item-total { font-weight: bold; width: 80px; text-align: right; }
        .cart-item-remove { background: none; border: none; color: var(--red); font-size: 18px; cursor: pointer; }
        .cart-footer { padding: 15px; border-top: 1px solid var(--border-color); margin-top: auto; }
        .cart-total { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        .cart-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 900px) { #posPage { grid-template-columns: 1fr; height: auto; } }

        /* --- Modal & Receipt Styles --- */
        .modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.6); }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; color: #888; }
        .modal-form .form-group { margin-bottom: 15px; }
        .modal-form label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-form input, .modal-form select, .modal-form textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; }
        .salary-field { position: relative; }
        .toggle-salary-visibility { position: absolute; right: 10px; top: 38px; cursor: pointer; user-select: none;}
        
        #receiptModal .modal-content { background: none; border: none; box-shadow: none; padding: 0; overflow: visible; max-width: 400px; }
        #receiptModal .modal-close { color: white; text-shadow: 0 1px 2px black; top: 0px; right: 0px; }
        .receipt-ticket { width: 100%; max-width: 380px; background: #fff; margin: 20px auto; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-family: 'Courier New', Courier, monospace; color: #222; }
        .receipt-header { text-align: center; margin-bottom: 20px; }
        .receipt-header h2 { font-size: 24px; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .receipt-header p { font-size: 12px; color: #555; margin: 5px 0 0; }
        .receipt-info p { font-size: 12px; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .receipt-separator { border-top: 2px dashed #888; margin: 15px 0; }
        .receipt-items table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .receipt-items th { text-align: left; padding-bottom: 8px; border-bottom: 1px solid #555; }
        .receipt-items td { padding: 8px 2px; }
        .receipt-items .item-details { display: block; font-size: 11px; color: #666; }
        .receipt-items .text-right { text-align: right; }
        .receipt-totals { margin-top: 15px; font-size: 14px; }
        .receipt-totals p { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .receipt-totals p.total { font-size: 20px; font-weight: bold; margin-top: 10px; padding-top: 10px; border-top: 1px solid #555; }
        .receipt-footer { text-align: center; margin-top: 20px; font-size: 12px; color: #555; }
        .receipt-actions { text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .receipt-ticket { box-shadow: none; margin: 0; border: none; }
            .modal-close, .receipt-actions { display: none; }
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h1>Business Manager</h1>
        <form id="loginForm"><div class="form-group"><label for="username">Username</label><input type="text" id="username" required></div><div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div><p id="loginError"></p><button type="submit" class="login-button">Login</button></form>
    </div>

    <div id="appContainer" class="hidden">
        <header class="main-header"><h1>Business Manager</h1><div class="header-controls"><span id="currentUserDisplay"></span><button id="logoutButton">Logout</button><button id="menuToggle">‚ò∞</button></div></header>
        <div id="mainMenu" class="hidden"></div>
        
        <main class="main-content">
            <div id="overviewPage" class="page">
                <h2>Dashboard Overview</h2>
                <div class="overview-grid" style="margin-top: 20px;">
                    <div class="stat-card"><h3>Total Goods in Stock</h3><p id="totalStockCount">0</p></div>
                    <div class="stat-card"><h3>Total Units Sold</h3><p id="totalSoldCount">0</p></div>
                    <div class="stat-card"><h3>Total Sales Value</h3><p id="totalSalesValue">‚Ç¶0</p></div>
                    <div class="stat-card capital profit-display"><h3>Current Capital</h3><p id="currentCapitalDisplay">‚Ç¶0</p></div>
                    <div class="stat-card profit profit-display">
                        <h3>Profit Account</h3><p id="profitAccountDisplay">‚Ç¶0</p>
                        <div class="stat-card-action admin-only"><button class="action-button edit-btn" onclick="showTransferToEWalletModal()">Transfer</button></div>
                    </div>
                    <div class="stat-card profit-display">
                        <h3>E-Wallet</h3><p id="eWalletDisplay">‚Ç¶0</p>
                        <div class="stat-card-action admin-only"><button class="action-button delete-btn" onclick="showEWalletWithdrawalModal()">Withdraw</button></div>
                    </div>
                </div>
                <div class="card hidden" id="lowStockTicker" style="margin-top: 20px; padding: 10px 20px; background-color: #fff3cd; border-left: 5px solid var(--yellow);"><div style="display: flex; align-items: center; gap: 10px;"><span style="font-size: 24px;">‚ö†Ô∏è</span><div style="font-weight: bold; flex-shrink: 0;">Low Stock Alert:</div><marquee behavior="scroll" direction="left" id="lowStockMarquee" style="width: 100%;"></marquee></div></div>
                <div class="card" style="margin-top: 20px;"><h3>Monthly Performance</h3><canvas id="trendsChart"></canvas></div>
            </div>
            <div id="posPage" class="page hidden"><div class="pos-panel"><div class="pos-panel-header"><input type="text" id="posProductSearch" placeholder="Search products..." style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color);"></div><div class="pos-panel-body" id="productCatalog"></div></div><div class="pos-panel"><div class="pos-panel-header"><h3>Current Sale</h3></div><div class="pos-panel-body"><ul id="cartItems"></ul></div><div class="cart-footer"><div class="cart-total"><span>TOTAL</span><span id="cartTotalDisplay">‚Ç¶0.00</span></div><div class="cart-actions"><button id="clearCartBtn" class="action-button delete-btn">Clear Cart</button><button id="finalizeSaleBtn" class="main-button" disabled>Finalize Sale</button></div></div></div></div>
            <div id="productManagementPage" class="page hidden"><h2>Product Management</h2><button id="addProductBtn" class="main-button">Add New Product</button><div class="filter-bar"><input type="text" id="productSearchInput" placeholder="Search by product name..."></div><div style="overflow-x:auto;"><table id="productTable"><thead><tr><th>Name</th><th>Category</th><th>Buying Price</th><th>Selling Price</th><th>In Stock</th><th>Sold</th><th>Supplier</th><th>Actions</th></tr></thead><tbody></tbody></table></div></div>
            <div id="salesLogPage" class="page hidden"><h2>Sales Log</h2><div class="filter-bar"><input type="text" id="salesLogSearchInput" placeholder="Search by Invoice #..."><input type="date" id="salesLogDateFilter"><button onclick="renderSalesLog()">Filter</button><button id="submitMySalesBtn" class="main-button" onclick="submitMySales()" disabled>Submit My Sales</button></div><div style="overflow-x:auto;"><table id="salesLogTable"><thead></thead><tbody></tbody></table></div></div>
            <div id="stockLevelPage" class="page hidden"><h2>Stock Level Monitoring</h2><div style="overflow-x:auto;"><table id="stockLevelTable"><thead><tr><th>Status</th><th>Product Name</th><th>Qty in Stock</th><th>Low Stock Threshold</th><th>Stock Level</th></tr></thead><tbody></tbody></table></div></div>
            <div id="plTrackerPage" class="page hidden"><h2>Profit and Loss Tracker</h2><div class="filter-bar"><label>Select Month:</label><input type="month" id="plMonthFilter"><button onclick="renderPLTracker()">View Report</button></div><div class="overview-grid"><div class="stat-card"><h3>Total Revenue</h3><p id="plTotalRevenue">‚Ç¶0</p></div><div class="stat-card"><h3>Cost of Goods Sold</h3><p id="plTotalCost">‚Ç¶0</p></div><div class="stat-card"><h3>Operating Expenses</h3><p id="plTotalExpenses">‚Ç¶0</p></div><div class="stat-card profit profit-display" id="plNetProfitCard"><h3>Net Profit/Loss</h3><p id="plNetProfit">‚Ç¶0</p></div></div></div>
            <div id="expensesManagerPage" class="page hidden"><h2>Monthly Expenses Manager</h2><button id="addExpenseBtn" class="main-button">Add New Expense</button><div style="overflow-x:auto;"><table id="expensesTable"><thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody></tbody></table></div></div>
            <div id="capitalTrackerPage" class="page hidden admin-only">
                <h2>Capital Tracker</h2><button id="addCapitalTransactionBtn" class="main-button">Add/Set Capital</button>
                <div class="card" style="margin-top:20px;"><h3>Summary</h3><div class="overview-grid"><div class="stat-card capital"><h3>Current Capital</h3><p id="summaryCapital">‚Ç¶0</p></div><div class="stat-card profit"><h3>Profit Account</h3><p id="summaryProfit">‚Ç¶0</p></div><div class="stat-card"><h3>E-Wallet Balance</h3><p id="summaryEWallet">‚Ç¶0</p></div></div></div>
                <div class="card" style="margin-top:20px;"><h3>Transaction History (Statement)</h3><div class="filter-bar"><label>From:</label><input type="date" id="transStartDate"><label>To:</label><input type="date" id="transEndDate"><button onclick="renderTransactionHistory()">Filter</button><button id="downloadTransPdfBtn" class="main-button">Download PDF</button><button id="downloadTransCsvBtn" class="main-button">Download CSV</button></div><div style="overflow-x:auto;"><table id="transactionHistoryTable"><thead><tr><th>Date</th><th>Description</th><th>Debit</th><th>Credit</th><th>Balance</th></tr></thead><tbody></tbody></table></div></div>
            </div>
            <div id="userManagementPage" class="page hidden admin-only"><h2>User Management</h2><button id="addUserBtn" class="main-button">Add New User</button><div style="overflow-x:auto;"><table id="userTable"><thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead><tbody></tbody></table></div></div>
            <div id="userSettingsPage" class="page hidden"><h2>User Settings</h2><div class="card"><h3>Change Your Password</h3><form id="changePasswordForm" class="modal-form"><div class="form-group"><label>Current Password</label><input type="password" id="currentPassword" required></div><div class="form-group"><label>New Password</label><input type="password" id="newPassword" minlength="4" required></div><div class="form-group"><label>Confirm New Password</label><input type="password" id="confirmNewPassword" required></div><button type="submit" class="main-button">Change Password</button><p id="passwordChangeStatus" style="margin-top:10px;"></p></form></div><div class="card" style="margin-top: 20px;"><h3>Data Management</h3><p style="margin-bottom: 15px; font-size: 14px; color: #666;">Backup your data to a file. <strong>Warning:</strong> Restoring will overwrite all current data.</p><div style="display: flex; gap: 10px; flex-wrap: wrap;"><button id="backupDataBtn" class="main-button">Download Backup</button><div class="form-group" style="display:flex; align-items:center; gap: 10px; margin-bottom: 0;"><input type="file" id="restoreDataInput" accept=".json"><button id="restoreDataBtn" class="action-button delete-btn">Restore from File</button></div></div></div></div>
        </main>
        <div><h5>Developed By Charleytech Hub: 09068420849</h5></div>
    </div>

    <!-- ======== MODALS ======== -->
    <div id="productModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('productModal')">&times;</span><h2 id="productModalTitle">Add Product</h2><form id="productForm" class="modal-form"><input type="hidden" id="productId"><input type="hidden" id="originalStock"><div class="form-group"><label>Product Name</label><input type="text" id="productName" required></div><div class="form-group"><label>Category</label><input type="text" id="productCategory" required></div><div class="form-group"><label>Buying Price (‚Ç¶)</label><input type="number" id="buyingPrice" min="0" step="0.01" required></div><div class="form-group"><label>Selling Price (‚Ç¶)</label><input type="number" id="sellingPrice" min="0" step="0.01" required></div><div class="form-group"><label for="quantityInStock">Quantity To Add</label><input type="number" id="quantityInStock" min="0" required></div><div class="form-group"><label>Low Stock Alert Level</label><input type="number" id="lowStockThreshold" min="0" value="10"></div><div class="form-group"><label>Supplier</label><input type="text" id="supplierInfo"></div><div class="form-group" id="purchaseDetailsGroup"><label>Date of Purchase</label><input type="date" id="purchaseDate" required></div><button type="submit" class="main-button">Save Product</button></form></div></div>
    <div id="expenseModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('expenseModal')">&times;</span><h2 id="expenseModalTitle">Add Expense</h2><form id="expenseForm" class="modal-form"><input type="hidden" id="expenseId"><div class="form-group"><label>Date</label><input type="date" id="expenseDate" required></div><div class="form-group"><label>Category</label><select id="expenseCategory" required><option value="Rent">Rent</option><option value="Utilities">Utilities</option><option value="Salaries">Salaries</option><option value="Transport">Transport</option><option value="Maintenance">Maintenance</option><option value="Miscellaneous">Miscellaneous</option></select></div><div class="form-group"><label>Description</label><input type="text" id="expenseDescription"></div><div class="form-group salary-field"><label>Amount (‚Ç¶)</label><input type="password" id="expenseAmount" min="0" step="0.01" required><span class="toggle-salary-visibility" onclick="toggleSalaryVisibility(this)">üëÅÔ∏è</span></div><button type="submit" class="main-button">Save Expense</button></form></div></div>
    <div id="capitalModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('capitalModal')">&times;</span><h2 id="capitalModalTitle">Capital Transaction</h2><form id="capitalForm" class="modal-form"><div class="form-group"><label>Date</label><input type="date" id="capitalDate" required></div><div class="form-group"><label>Transaction Type</label><select id="capitalType" required><option value="initial">Set Initial Capital</option><option value="injection">Capital Injection</option><option value="withdrawal">Capital Withdrawal</option></select></div><div class="form-group"><label>Amount (‚Ç¶)</label><input type="number" id="capitalAmount" min="0" step="0.01" required></div><div class="form-group"><label>Notes (Optional)</label><textarea id="capitalNotes" rows="3"></textarea></div><button type="submit" class="main-button">Save Transaction</button></form></div></div>
    <div id="userModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('userModal')">&times;</span><h2 id="userModalTitle">Add User</h2><form id="userForm" class="modal-form"><input type="hidden" id="userId"><div class="form-group"><label>Username</label><input type="text" id="userUsername" required></div><div class="form-group"><label>Password</label><input type="password" id="userPassword" minlength="4" required></div><div class="form-group"><label>Role</label><select id="userRole" required><option value="salesRep">Sales Rep</option><option value="manager">Manager</option><option value="auditor">Auditor</option><option value="admin">Admin</option></select></div><button type="submit" class="main-button">Save User</button></form></div></div>
    <div id="checkoutModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('checkoutModal')">&times;</span><h2>Finalize Sale</h2><form id="checkoutForm" class="modal-form"><div class="form-group"><label>Customer Name (Optional)</label><input type="text" id="customerName" placeholder="Walk-in Customer"></div><button type="submit" class="main-button">Complete Sale</button></form></div></div>
    <div id="transferToEWalletModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('transferToEWalletModal')">&times;</span><h2>Transfer to E-Wallet</h2><form id="transferToEWalletForm" class="modal-form"><p>Available: <strong id="availableProfitForTransfer">‚Ç¶0.00</strong></p><div class="form-group"><label>Amount</label><input type="number" id="transferAmount" min="0.01" step="0.01" required></div><button type="submit" class="main-button">Transfer</button></form></div></div>
    <div id="eWalletWithdrawalModal" class="modal hidden"><div class="modal-content"><span class="modal-close" onclick="closeModal('eWalletWithdrawalModal')">&times;</span><h2>E-Wallet Withdrawal</h2><form id="eWalletWithdrawalForm" class="modal-form"><p>Available: <strong id="availableEWalletForWithdrawal">‚Ç¶0.00</strong></p><div class="form-group"><label>Amount</label><input type="number" id="withdrawalAmount" min="0.01" step="0.01" required></div><div class="form-group"><label>Notes</label><input type="text" id="withdrawalNotes"></div><button type="submit" class="main-button">Withdraw</button></form></div></div>

    <!-- NEW: Receipt Modal -->
    <div id="receiptModal" class="modal hidden">
        <div class="modal-content">
            <div id="print-area">
                <div id="receiptContainer"></div>
            </div>
            <div id="receiptActions" class="receipt-actions">
                <!-- Buttons are added dynamically by JS -->
            </div>
            <span class="modal-close" onclick="closeModal('receiptModal')">&times;</span>
        </div>
    </div>

<script>
if (!window.structuredClone) { window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj)); }

document.addEventListener('DOMContentLoaded', () => {
    let db;
    let currentUser = null;
    let trendsChart = null;
    let salesCart = [];
    const DB_KEY = 'businessManagerDB_v10_receipts'; 

    const DEFAULT_DB = { users: [], products: [], sales: [], purchases: [], expenses: [], transactions: [], profitAccount: 0, eWallet: 0 };
    function loadDatabase() { const data = localStorage.getItem(DB_KEY); db = data ? JSON.parse(data) : structuredClone(DEFAULT_DB); Object.keys(DEFAULT_DB).forEach(key => { if (!db[key]) db[key] = structuredClone(DEFAULT_DB[key]); }); if (db.users.length === 0) { db.users.push({ id: generateId(), username: 'admin', password: 'password', role: 'admin' }, { id: generateId(), username: 'manager', password: 'password', role: 'manager' }, { id: generateId(), username: 'sales', password: 'password', role: 'salesRep' }); saveDatabase(); } }
    function saveDatabase() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }
    function formatNaira(amount) { return `‚Ç¶${Number(amount).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`; }
    
    // ======================= AUTH & UI ==========================
    document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); const user = db.users.find(u => u.username === document.getElementById('username').value && u.password === document.getElementById('password').value); if (user) { login(user); } else { document.getElementById('loginError').textContent = 'Invalid credentials.'; } });
    function login(user) { currentUser = user; document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('appContainer').classList.remove('hidden'); document.getElementById('loginForm').reset(); setupUIForRole(); renderAll(); }
    function logout() { currentUser = null; salesCart = []; document.getElementById('loginScreen').classList.remove('hidden'); document.getElementById('appContainer').classList.add('hidden'); }
    document.getElementById('logoutButton').addEventListener('click', logout);

    function setupUIForRole() {
        document.getElementById('currentUserDisplay').textContent = `User: ${currentUser.username} (${currentUser.role})`;
        const appContainer = document.getElementById('appContainer'); appContainer.className = ''; appContainer.classList.add(`role-${currentUser.role}`);
        const menuItems = { 'Dashboard': { page: 'overviewPage', roles: ['admin', 'manager', 'auditor', 'salesRep'] }, 'Point of Sale': { page: 'posPage', roles: ['admin', 'manager', 'salesRep'] }, 'Sales Log': { page: 'salesLogPage', roles: ['admin', 'manager', 'salesRep', 'auditor'] }, 'Product Management': { page: 'productManagementPage', roles: ['admin', 'manager'] }, 'Stock Monitoring': { page: 'stockLevelPage', roles: ['admin', 'manager', 'salesRep', 'auditor'] }, 'P&L Tracker': { page: 'plTrackerPage', roles: ['admin', 'manager', 'auditor'] }, 'Expenses': { page: 'expensesManagerPage', roles: ['admin', 'manager'] }, 'Capital Tracker': { page: 'capitalTrackerPage', roles: ['admin'] }, 'User Management': { page: 'userManagementPage', roles: ['admin'] }, 'Settings': { page: 'userSettingsPage', roles: ['admin', 'manager', 'salesRep', 'auditor'] }, };
        const menuContainer = document.getElementById('mainMenu'); menuContainer.innerHTML = '';
        Object.entries(menuItems).forEach(([title, item]) => { if (item.roles.includes(currentUser.role)) { const link = document.createElement('a'); link.href = '#'; link.textContent = title; link.dataset.page = item.page; menuContainer.appendChild(link); } });
        showPage(currentUser.role === 'salesRep' ? 'posPage' : 'overviewPage');
    }
    function showPage(pageId) { document.querySelectorAll('.page').forEach(page => page.classList.add('hidden')); const pageToShow = document.getElementById(pageId); if(pageToShow) pageToShow.classList.remove('hidden'); document.getElementById('mainMenu').classList.add('hidden'); const renderMap = { posPage: renderPosPage, capitalTrackerPage: renderCapitalTracker, stockLevelPage: renderStockLevels, salesLogPage: renderSalesLog, userManagementPage: renderUserManagement, productManagementPage: renderProductManagement, expensesManagerPage: renderExpenses }; renderMap[pageId]?.(); }
    document.getElementById('mainMenu').addEventListener('click', (e) => e.target.dataset.page && (e.preventDefault(), showPage(e.target.dataset.page)));
    document.getElementById('menuToggle').addEventListener('click', () => document.getElementById('mainMenu').classList.toggle('hidden'));
    
    window.showModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

    // ===================== FINANCIAL LOGIC & WORKFLOWS =======================
    function getCurrentCapital() { if (db.transactions.length === 0) return 0; return db.transactions.sort((a, b) => new Date(b.date) - new Date(a.date) || b.id.localeCompare(a.id))[0].balance; }
    function logTransaction(details) { const { date, description, debit = 0, credit = 0 } = details; const lastBalance = db.transactions.length > 0 ? getCurrentCapital() : 0; db.transactions.push({ id: generateId(), date: date || new Date().toISOString().split('T')[0], description, debit, credit, balance: lastBalance - debit + credit }); saveDatabase(); }
    
    window.submitMySales = function() {
        const salesToSubmit = db.sales.filter(s => s.userId === currentUser.id && !s.submitted);
        if (salesToSubmit.length === 0) { alert('You have no pending sales to submit.'); return; }
        
        let confirmationMessage = `You are about to submit ${salesToSubmit.length} pending sale(s). This action cannot be undone. Proceed?`;
        if (['admin', 'manager'].includes(currentUser.role)) {
            const totalValue = salesToSubmit.reduce((sum, s) => sum + s.grandTotal, 0);
            confirmationMessage = `You are about to submit ${salesToSubmit.length} sale(s) with a total value of ${formatNaira(totalValue)}. This will finalize the transaction. Proceed?`;
        }
        if (confirm(confirmationMessage)) {
            const totalProfit = salesToSubmit.reduce((sum, s) => sum + s.totalProfit, 0);
            const totalCOGS = salesToSubmit.reduce((sum, s) => sum + s.totalCOGS, 0);
            logTransaction({ description: `COGS return from ${salesToSubmit.length} submitted sales by ${currentUser.username}`, credit: totalCOGS });
            db.profitAccount += totalProfit;
            salesToSubmit.forEach(sale => { const saleInDb = db.sales.find(s => s.invoiceNumber === sale.invoiceNumber); if (saleInDb) saleInDb.submitted = true; });
            saveDatabase();
            alert('Sales submitted successfully!');
            renderAll();
            renderSalesLog();
        }
    }

    // ===================== RENDERING FUNCTIONS =======================
    function renderAll() { renderOverview(); renderPLTracker(); }
    function renderOverview() {
        document.getElementById('totalStockCount').textContent = db.products.reduce((s, p) => s + p.quantityInStock, 0).toLocaleString(); document.getElementById('totalSoldCount').textContent = db.products.reduce((s, p) => s + (p.quantitySold || 0), 0).toLocaleString(); document.getElementById('totalSalesValue').textContent = formatNaira(db.sales.reduce((s, sale) => s + sale.grandTotal, 0));
        if (['admin', 'auditor', 'manager'].includes(currentUser.role)) { document.getElementById('currentCapitalDisplay').textContent = formatNaira(getCurrentCapital()); document.getElementById('profitAccountDisplay').textContent = formatNaira(db.profitAccount); document.getElementById('eWalletDisplay').textContent = formatNaira(db.eWallet); }
        renderLowStockTicker(); renderTrendsChart();
    }
    function renderTrendsChart() {
        const ctx = document.getElementById('trendsChart').getContext('2d'); const salesByMonth = {}; const profitByMonth = {};
        db.sales.forEach(s => { const m = s.date.substring(0, 7); salesByMonth[m] = (salesByMonth[m] || 0) + s.grandTotal; profitByMonth[m] = (profitByMonth[m] || 0) + s.totalProfit; }); db.expenses.forEach(e => { const m = e.date.substring(0, 7); profitByMonth[m] = (profitByMonth[m] || 0) - e.amount; });
        const labels = [...new Set([...Object.keys(salesByMonth), ...Object.keys(profitByMonth)])].sort(); const salesData = labels.map(l => salesByMonth[l] || 0); let datasets = [{ type: 'bar', label: 'Monthly Sales', data: salesData, backgroundColor: 'rgba(10, 147, 150, 0.6)', yAxisID: 'y' }];
        if (['admin', 'auditor', 'manager'].includes(currentUser.role)) { datasets.unshift({ type: 'line', label: 'Monthly Net Profit', data: labels.map(l => profitByMonth[l] || 0), borderColor: 'var(--green)', tension: 0.1, yAxisID: 'y1' }); }
        if (trendsChart) trendsChart.destroy(); trendsChart = new Chart(ctx, { type: 'bar', data: { labels, datasets }, options: { scales: { y: { beginAtZero: true }, y1: { position: 'right', grid: { drawOnChartArea: false }, display: ['admin', 'auditor', 'manager'].includes(currentUser.role) } } } });
    }

    // ===================== POINT OF SALE =======================
    function renderPosPage() { renderProductCatalog(); renderCart(); }
    function renderProductCatalog() { const catalog = document.getElementById('productCatalog'); const search = document.getElementById('posProductSearch').value.toLowerCase(); catalog.innerHTML = ''; db.products.filter(p => p.name.toLowerCase().includes(search)).sort((a,b) => a.name.localeCompare(b.name)).forEach(p => { const card = document.createElement('div'); card.className = p.quantityInStock <= 0 ? 'product-card disabled' : 'product-card'; card.dataset.productId = p.id; card.innerHTML = `<div class="product-card-name">${p.name}</div><div class="product-card-price">${formatNaira(p.sellingPrice)}</div><div class="product-card-stock">Stock: ${p.quantityInStock}</div>`; catalog.appendChild(card); }); }
    function renderCart() { const list = document.getElementById('cartItems'); list.innerHTML = ''; let total = 0; if (salesCart.length === 0) { list.innerHTML = '<p style="text-align:center; color:#888; padding:20px;">Cart is empty</p>'; } else { salesCart.forEach(item => { const itemTotal = item.sellingPrice * item.quantity; total += itemTotal; list.innerHTML += `<li class="cart-item"><span class="cart-item-name">${item.name}</span><div class="cart-item-qty"><button onclick="updateCartQuantity('${item.id}', ${item.quantity - 1})">-</button><span>${item.quantity}</span><button onclick="updateCartQuantity('${item.id}', ${item.quantity + 1})">+</button></div><span class="cart-item-total">${formatNaira(itemTotal)}</span><button class="cart-item-remove" onclick="removeFromCart('${item.id}')">&times;</button></li>`; }); } document.getElementById('cartTotalDisplay').textContent = formatNaira(total); document.getElementById('finalizeSaleBtn').disabled = salesCart.length === 0; }
    function addToCart(productId) { const product = db.products.find(p => p.id === productId); if (!product || product.quantityInStock <= 0) return; const item = salesCart.find(i => i.id === productId); if (item) { if (item.quantity < product.quantityInStock) item.quantity++; else alert('Max stock reached.'); } else { salesCart.push({ ...product, quantity: 1 }); } renderCart(); }
    window.updateCartQuantity = (id, qty) => { const item = salesCart.find(i => i.id === id); const product = db.products.find(p => p.id === id); if (!item || !product) return; if (qty <= 0) { removeFromCart(id); } else if (qty > product.quantityInStock) { item.quantity = product.quantityInStock; alert('Max stock reached.'); } else { item.quantity = qty; } renderCart(); };
    window.removeFromCart = (id) => { salesCart = salesCart.filter(i => i.id !== id); renderCart(); };
    
    function finalizeSale() {
        const now = new Date(); const saleRecord = { invoiceNumber: `INV-${Date.now()}`, date: now.toISOString().split('T')[0], dateTime: now.toISOString(), userId: currentUser.id, customerName: document.getElementById('customerName').value || 'Walk-in Customer', submitted: false, items: structuredClone(salesCart.map(i => ({ productId: i.id, productName: i.name, quantity: i.quantity, sellingPrice: i.sellingPrice, buyingPrice: i.buyingPrice }))), grandTotal: salesCart.reduce((s, i) => s + (i.sellingPrice * i.quantity), 0), totalProfit: salesCart.reduce((s, i) => s + ((i.sellingPrice - i.buyingPrice) * i.quantity), 0), totalCOGS: salesCart.reduce((s, i) => s + (i.buyingPrice * i.quantity), 0), };
        saleRecord.items.forEach(item => { const product = db.products.find(p => p.id === item.productId); if (product) { product.quantityInStock -= item.quantity; product.quantitySold = (product.quantitySold || 0) + item.quantity; } });
        db.sales.push(saleRecord); saveDatabase(); salesCart = [];
        closeModal('checkoutModal'); renderAll(); showPage('posPage');
        showReceiptForSale(saleRecord.invoiceNumber); // MODIFIED: Show receipt after sale
    }

    document.getElementById('productCatalog').addEventListener('click', (e) => { const card = e.target.closest('.product-card:not(.disabled)'); if (card) addToCart(card.dataset.productId); });
    document.getElementById('posProductSearch').addEventListener('input', renderProductCatalog);
    document.getElementById('clearCartBtn').addEventListener('click', () => { salesCart = []; renderCart(); });
    document.getElementById('finalizeSaleBtn').addEventListener('click', () => { document.getElementById('checkoutForm').reset(); showModal('checkoutModal'); });
    document.getElementById('checkoutForm').addEventListener('submit', (e) => { e.preventDefault(); finalizeSale(); });
    
    // ===================== PRODUCT MANAGEMENT =======================
    function renderProductManagement() { const tbody = document.getElementById('productTable').querySelector('tbody'); tbody.innerHTML = ''; db.products.filter(p => p.name.toLowerCase().includes(document.getElementById('productSearchInput').value.toLowerCase())).forEach(p => { tbody.innerHTML += `<tr><td>${p.name}</td><td>${p.category}</td><td>${formatNaira(p.buyingPrice)}</td><td>${formatNaira(p.sellingPrice)}</td><td>${p.quantityInStock}</td><td>${p.quantitySold || 0}</td><td>${p.supplier || 'N/A'}</td><td><button class="action-button edit-btn" onclick="editProduct('${p.id}')">Edit</button><button class="action-button delete-btn" onclick="deleteProduct('${p.id}')">Delete</button></td></tr>`; }); }
    document.getElementById('addProductBtn').addEventListener('click', () => { document.getElementById('productForm').reset(); document.getElementById('productId').value = ''; document.getElementById('productModalTitle').textContent = 'Add New Product'; document.getElementById('purchaseDate').valueAsDate = new Date(); document.querySelector('#productModal label[for="quantityInStock"]').textContent = "Quantity to Add"; showModal('productModal'); });
    window.editProduct = (id) => { const p = db.products.find(p => p.id === id); if (!p) return; document.getElementById('productId').value = p.id; document.getElementById('productName').value = p.name; document.getElementById('productCategory').value = p.category; document.getElementById('buyingPrice').value = p.buyingPrice; document.getElementById('sellingPrice').value = p.sellingPrice; document.getElementById('quantityInStock').value = 0; document.getElementById('originalStock').value = p.quantityInStock; document.getElementById('lowStockThreshold').value = p.lowStockThreshold || 10; document.getElementById('supplierInfo').value = p.supplier; document.getElementById('productModalTitle').textContent = `Edit / Add Stock for ${p.name}`; document.querySelector('#productModal label[for="quantityInStock"]').textContent = `Add more stock (Current: ${p.quantityInStock})`; showModal('productModal'); }
    document.getElementById('productForm').addEventListener('submit', (e) => { e.preventDefault(); if (db.transactions.length === 0 && (currentUser.role === 'admin' || currentUser.role === 'manager')) { alert('Cannot save product. Please set an initial capital first via the Capital Tracker.'); return; } const id = document.getElementById('productId').value; const buyingPrice = parseFloat(document.getElementById('buyingPrice').value); const quantityToAdd = parseInt(document.getElementById('quantityInStock').value); const cost = buyingPrice * quantityToAdd; if (cost > getCurrentCapital() && (currentUser.role === 'admin' || currentUser.role === 'manager')) { alert(`Insufficient capital. Required: ${formatNaira(cost)} but only ${formatNaira(getCurrentCapital())} is available.`); return; } const productData = { name: document.getElementById('productName').value, category: document.getElementById('productCategory').value, buyingPrice, sellingPrice: parseFloat(document.getElementById('sellingPrice').value), supplier: document.getElementById('supplierInfo').value, lowStockThreshold: parseInt(document.getElementById('lowStockThreshold').value) }; if (id) { const product = db.products.find(p => p.id === id); Object.assign(product, productData); if (quantityToAdd > 0) { product.quantityInStock += quantityToAdd; logTransaction({ description: `Restock: ${quantityToAdd} of ${product.name}`, debit: cost }); } } else { productData.id = generateId(); productData.quantityInStock = quantityToAdd; productData.quantitySold = 0; db.products.push(productData); logTransaction({ date: document.getElementById('purchaseDate').value, description: `Purchase: ${quantityToAdd} of ${productData.name}`, debit: cost }); } saveDatabase(); renderAll(); showPage('productManagementPage'); closeModal('productModal'); });
    window.deleteProduct = (id) => { if (confirm('Are you sure? This cannot be undone.')) { db.products = db.products.filter(p => p.id !== id); saveDatabase(); renderAll(); } }
    
    // ===================== EXPENSES MANAGEMENT ======================
    function renderExpenses() { const tbody = document.getElementById('expensesTable').querySelector('tbody'); tbody.innerHTML = ''; db.expenses.forEach(e => { tbody.innerHTML += `<tr><td>${e.date}</td><td>${e.category}</td><td>${e.description || 'N/A'}</td><td>${formatNaira(e.amount)}</td><td><button class="action-button edit-btn" onclick="editExpense('${e.id}')">Edit</button><button class="action-button delete-btn" onclick="deleteExpense('${e.id}')">Delete</button></td></tr>` }); }
    document.getElementById('addExpenseBtn').addEventListener('click', () => { document.getElementById('expenseForm').reset(); document.getElementById('expenseId').value = ''; document.getElementById('expenseModalTitle').textContent = 'Add New Expense'; document.getElementById('expenseDate').valueAsDate = new Date(); showModal('expenseModal'); });
    document.getElementById('expenseForm').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('expenseId').value; const amount = parseFloat(document.getElementById('expenseAmount').value); const expenseData = { date: document.getElementById('expenseDate').value, category: document.getElementById('expenseCategory').value, description: document.getElementById('expenseDescription').value, amount }; if (id) { const oldExpense = db.expenses.find(exp => exp.id === id); const difference = amount - oldExpense.amount; if (difference > db.profitAccount && (currentUser.role === 'admin' || currentUser.role === 'manager')) { alert(`Insufficient profit funds to cover the increase.`); return; } db.profitAccount -= difference; Object.assign(oldExpense, expenseData); } else { if (amount > db.profitAccount && (currentUser.role === 'admin' || currentUser.role === 'manager')) { alert(`Insufficient profit funds. Available: ${formatNaira(db.profitAccount)}`); return; } db.profitAccount -= amount; expenseData.id = generateId(); db.expenses.push(expenseData); } saveDatabase(); renderAll(); showPage('expensesManagerPage'); closeModal('expenseModal'); });
    window.deleteExpense = (id) => { if (confirm('This will return the amount to the Profit Account. Continue?')) { const idx = db.expenses.findIndex(e => e.id === id); if(idx > -1) { db.profitAccount += db.expenses[idx].amount; db.expenses.splice(idx, 1); saveDatabase(); renderAll(); } } }

    // ===================== OTHER DASHBOARDS ======================
    window.renderSalesLog = function() {
        const tbody = document.getElementById('salesLogTable').querySelector('tbody'); tbody.innerHTML = ''; const search = document.getElementById('salesLogSearchInput').value.toLowerCase(); const date = document.getElementById('salesLogDateFilter').value;
        const showProfit = ['admin', 'auditor', 'manager'].includes(currentUser.role); let headers = ['Invoice #', 'Date & Time', 'Items', 'Total'];
        if (showProfit) headers.push('Profit'); headers.push('Customer', 'Sold By', 'Status', 'Actions'); document.getElementById('salesLogTable').querySelector('thead').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        db.sales.filter(s => (!search || s.invoiceNumber.toLowerCase().includes(search)) && (!date || s.date === date)).sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime)).forEach(s => { const seller = db.users.find(u => u.id === s.userId); const statusHtml = s.submitted ? `<span style="color:var(--green);">‚úî Submitted</span>` : `<span style="color:var(--yellow); font-weight:bold;">Pending</span>`; let rowHtml = `<td>${s.invoiceNumber}</td><td>${new Date(s.dateTime).toLocaleString()}</td><td>${s.items.length}</td><td>${formatNaira(s.grandTotal)}</td>`; if (showProfit) rowHtml += `<td>${formatNaira(s.totalProfit)}</td>`; rowHtml += `<td>${s.customerName}</td><td>${seller ? seller.username : 'N/A'}</td><td>${statusHtml}</td><td><button class="action-button edit-btn" onclick="showReceiptForSale('${s.invoiceNumber}')">Receipt</button>${currentUser.role === 'admin' && s.submitted ? `<button class="action-button delete-btn" onclick="deleteSale('${s.invoiceNumber}')">Reverse</button>` : ''}</td>`; tbody.innerHTML += `<tr>${rowHtml}</tr>`; });
        const pendingSales = db.sales.some(s => s.userId === currentUser.id && !s.submitted); document.getElementById('submitMySalesBtn').disabled = !pendingSales;
    }
    window.deleteSale = (invoiceNumber) => { const saleIndex = db.sales.findIndex(s => s.invoiceNumber === invoiceNumber); if (saleIndex === -1) return; const sale = db.sales[saleIndex]; if (confirm(`ADMIN ACTION: This will reverse the financial impact of sale ${sale.invoiceNumber} and return stock. Are you sure?`)) { logTransaction({ description: `REVERSAL: Sale ${sale.invoiceNumber}`, debit: sale.totalCOGS }); db.profitAccount -= sale.totalProfit; sale.items.forEach(item => { const p = db.products.find(p => p.id === item.productId); if (p) { p.quantityInStock += item.quantity; p.quantitySold -= item.quantity; } }); db.sales.splice(saleIndex, 1); saveDatabase(); renderAll(); renderSalesLog(); } };
    function renderStockLevels() { const tbody = document.getElementById('stockLevelTable').querySelector('tbody'); tbody.innerHTML = ''; db.products.forEach(p => { let statusText, statusColor; if (p.quantityInStock <= 0) { statusText = 'Out of Stock'; statusColor = 'var(--red)'; } else if (p.quantityInStock <= (p.lowStockThreshold || 10)) { statusText = 'Low Stock'; statusColor = 'var(--yellow)'; } else { statusText = 'In Stock'; statusColor = 'var(--green)'; } const stockPercent = (p.quantityInStock / (p.quantityInStock + (p.quantitySold || 0))) * 100 || 0; tbody.innerHTML += `<tr><td><span style="color:${statusColor};font-weight:bold;">${statusText}</span></td><td>${p.name}</td><td>${p.quantityInStock}</td><td>${p.lowStockThreshold || 10}</td><td><div style="width:100%;background:#eee;border-radius:5px;"><div style="width:${stockPercent}%;height:10px;background:${statusColor};"></div></div></td></tr>`; }); }
    function renderUserManagement() { const tbody = document.getElementById('userTable').querySelector('tbody'); tbody.innerHTML = ''; db.users.forEach(user => { tbody.innerHTML += `<tr><td>${user.username}</td><td>${user.role}</td><td><button class="action-button edit-btn" onclick="editUser('${user.id}')">Edit</button>${user.id !== currentUser.id ? `<button class="action-button delete-btn" onclick="deleteUser('${user.id}')">Delete</button>` : ''}</td></tr>`; }); }
    
    // ===================== CAPITAL & TRANSACTION HISTORY ======================
    function renderCapitalTracker() { document.getElementById('summaryCapital').textContent = formatNaira(getCurrentCapital()); document.getElementById('summaryProfit').textContent = formatNaira(db.profitAccount); document.getElementById('summaryEWallet').textContent = formatNaira(db.eWallet); renderTransactionHistory(); }
    window.renderTransactionHistory = function() {
        const tbody = document.getElementById('transactionHistoryTable').querySelector('tbody'); tbody.innerHTML = '';
        const start = document.getElementById('transStartDate').value, end = document.getElementById('transEndDate').value;
        const allTrans = db.transactions.sort((a,b) => new Date(a.date) - new Date(b.date) || a.id.localeCompare(b.id));
        const before = allTrans.filter(t => start && t.date < start);
        const opening = before.length > 0 ? before[before.length-1].balance : 0;
        const filtered = allTrans.filter(t => (!start || t.date >= start) && (!end || t.date <= end));
        tbody.innerHTML = `<tr><td colspan="4" style="font-weight:bold;text-align:right;">Opening Balance</td><td style="font-weight:bold;">${formatNaira(opening)}</td></tr>`;
        let runningBalance = opening;
        filtered.forEach(t => { runningBalance = runningBalance - t.debit + t.credit; tbody.innerHTML += `<tr><td>${t.date}</td><td>${t.description}</td><td class="text-debit">${t.debit > 0 ? formatNaira(t.debit) : ''}</td><td class="text-credit">${t.credit > 0 ? formatNaira(t.credit) : ''}</td><td>${formatNaira(runningBalance)}</td></tr>`; });
        if (filtered.length > 0) tbody.innerHTML += `<tr><td colspan="4" style="font-weight:bold;text-align:right;">Closing Balance</td><td style="font-weight:bold;">${formatNaira(runningBalance)}</td></tr>`;
    }
    document.getElementById('addCapitalTransactionBtn').addEventListener('click', () => { document.getElementById('capitalForm').reset(); document.getElementById('capitalDate').valueAsDate = new Date(); showModal('capitalModal'); });
    document.getElementById('capitalForm').addEventListener('submit', e => { e.preventDefault(); const type = document.getElementById('capitalType').value, amount = parseFloat(document.getElementById('capitalAmount').value), notes = document.getElementById('capitalNotes').value, date = document.getElementById('capitalDate').value; if (type === 'initial') { logTransaction({ date, description: `Set Initial Capital`, credit: amount }); } else if (type === 'injection') { logTransaction({ date, description: `Capital Injection: ${notes}`, credit: amount }); } else if (type === 'withdrawal') { logTransaction({ date, description: `Capital Withdrawal: ${notes}`, debit: amount }); } renderCapitalTracker(); closeModal('capitalModal'); });
    window.showTransferToEWalletModal = () => { document.getElementById('availableProfitForTransfer').textContent = formatNaira(db.profitAccount); showModal('transferToEWalletModal'); }
    document.getElementById('transferToEWalletForm').addEventListener('submit', e => { e.preventDefault(); const amount = parseFloat(document.getElementById('transferAmount').value); if (amount > db.profitAccount) { alert('Amount exceeds profit.'); return; } db.profitAccount -= amount; db.eWallet += amount; saveDatabase(); renderAll(); closeModal('transferToEWalletModal'); });
    window.showEWalletWithdrawalModal = () => { document.getElementById('availableEWalletForWithdrawal').textContent = formatNaira(db.eWallet); showModal('eWalletWithdrawalModal'); }
    document.getElementById('eWalletWithdrawalForm').addEventListener('submit', e => { e.preventDefault(); const amount = parseFloat(document.getElementById('withdrawalAmount').value); const notes = document.getElementById('withdrawalNotes').value || 'E-Wallet Withdrawal'; if (amount > db.eWallet) { alert('Amount exceeds E-Wallet balance.'); return; } db.eWallet -= amount; logTransaction({ description: notes, debit: amount }); saveDatabase(); renderAll(); closeModal('eWalletWithdrawalModal'); });

    // ===================== NEW: RECEIPT FUNCTIONS =======================
    window.showReceiptForSale = function(invoiceNumber) {
        const sale = db.sales.find(s => s.invoiceNumber === invoiceNumber);
        if (!sale) return;
        const seller = db.users.find(u => u.id === sale.userId);
        
        const receiptContainer = document.getElementById('receiptContainer');
        const actionsContainer = document.getElementById('receiptActions');
        
        let itemsHtml = '';
        sale.items.forEach(item => {
            itemsHtml += `
                <tr>
                    <td>
                        ${item.productName}
                        <span class="item-details">${item.quantity} x ${formatNaira(item.sellingPrice)}</span>
                    </td>
                    <td class="text-right">${formatNaira(item.sellingPrice * item.quantity)}</td>
                </tr>
            `;
        });
        
        receiptContainer.innerHTML = `
            <div class="receipt-ticket">
                <div class="receipt-header">
                    <h2>Your Business Name</h2>
                    <p>123 Business Rd, City, State</p>
                </div>
                <div class="receipt-separator"></div>
                <div class="receipt-info">
                    <p><span>Invoice #:</span> <span>${sale.invoiceNumber}</span></p>
                    <p><span>Date:</span> <span>${new Date(sale.dateTime).toLocaleString()}</span></p>
                    <p><span>Cashier:</span> <span>${seller ? seller.username : 'N/A'}</span></p>
                    <p><span>Customer:</span> <span>${sale.customerName}</span></p>
                </div>
                <div class="receipt-separator"></div>
                <div class="receipt-items">
                    <table>
                        <thead><tr><th>ITEM</th><th class="text-right">TOTAL</th></tr></thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                </div>
                <div class="receipt-separator"></div>
                <div class="receipt-totals">
                    <p><span>Subtotal</span> <span class="text-right">${formatNaira(sale.grandTotal)}</span></p>
                    <p class="total"><span>TOTAL</span> <span class="text-right">${formatNaira(sale.grandTotal)}</span></p>
                </div>
                <div class="receipt-footer">
                    <p>Thank you for your patronage!</p>
                </div>
            </div>
        `;
        
        actionsContainer.innerHTML = `
            <button class="main-button" onclick="printReceipt()">Print Receipt</button>
            <button class="action-button edit-btn" onclick="downloadReceiptAsPDF('${sale.invoiceNumber}')">Download PDF</button>
        `;
        
        showModal('receiptModal');
    }

    window.printReceipt = function() { window.print(); }

    window.downloadReceiptAsPDF = function(invoiceNumber) {
        const sale = db.sales.find(s => s.invoiceNumber === invoiceNumber);
        if (!sale) return;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: [80, 200] }); // 80mm wide thermal paper style
        let y = 10;

        doc.setFontSize(14);
        doc.text('Your Business Name', 40, y, { align: 'center' });
        y += 5;
        doc.setFontSize(8);
        doc.text('123 Business Rd, City, State', 40, y, { align: 'center' });
        y += 8;

        doc.text(`Invoice: ${sale.invoiceNumber}`, 5, y);
        y += 4;
        doc.text(`Date: ${new Date(sale.dateTime).toLocaleString()}`, 5, y);
        y += 8;

        const tableData = sale.items.map(item => [
            `${item.productName}\n  ${item.quantity} x ${formatNaira(item.sellingPrice)}`,
            formatNaira(item.quantity * item.sellingPrice)
        ]);
        
        doc.autoTable({
            startY: y,
            head: [['Item', 'Total']],
            body: tableData,
            theme: 'plain',
            styles: { fontSize: 8, cellPadding: 1 },
            columnStyles: { 1: { halign: 'right' } }
        });
        
        y = doc.lastAutoTable.finalY + 8;
        doc.setFontSize(10);
        doc.text('Subtotal', 5, y);
        doc.text(formatNaira(sale.grandTotal), 75, y, { align: 'right' });
        y += 6;
        doc.setFont(undefined, 'bold');
        doc.text('TOTAL', 5, y);
        doc.text(formatNaira(sale.grandTotal), 75, y, { align: 'right' });
        y += 10;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(8);
        doc.text('Thank you for your patronage!', 40, y, { align: 'center' });

        doc.save(`Receipt-${sale.invoiceNumber}.pdf`);
    }

    // ... All other functions from previous version (user management, settings, backup/restore, etc.) remain here ...
    window.toggleSalaryVisibility = function(element) { const input = element.previousElementSibling; input.type = input.type === 'password' ? 'text' : 'password'; element.textContent = input.type === 'password' ? 'üëÅÔ∏è' : 'üôà'; }
    function renderLowStockTicker() { const ticker = document.getElementById('lowStockTicker'); const marquee = document.getElementById('lowStockMarquee'); const alerts = db.products.filter(p => p.quantityInStock <= (p.lowStockThreshold || 10)).sort((a,b) => a.quantityInStock - b.quantityInStock); if (alerts.length > 0) { marquee.innerHTML = alerts.map(p => `${p.name} (${p.quantityInStock <= 0 ? 'Out of Stock' : p.quantityInStock + ' left'})`).join(' &nbsp; | &nbsp; '); ticker.classList.remove('hidden'); } else { ticker.classList.add('hidden'); } }
    window.renderPLTracker = function() { const month = document.getElementById('plMonthFilter').value || new Date().toISOString().slice(0, 7); if(!document.getElementById('plMonthFilter').value) document.getElementById('plMonthFilter').value = month; const sales = db.sales.filter(s => s.date.startsWith(month)); const expenses = db.expenses.filter(e => e.date.startsWith(month)); const revenue = sales.reduce((s, a) => s + a.grandTotal, 0); const cogs = sales.reduce((s, a) => s + a.totalCOGS, 0); const totalExp = expenses.reduce((s, a) => s + a.amount, 0); const netProfit = revenue - cogs - totalExp; document.getElementById('plTotalRevenue').textContent = formatNaira(revenue); document.getElementById('plTotalCost').textContent = formatNaira(cogs); document.getElementById('plTotalExpenses').textContent = formatNaira(totalExp); document.getElementById('plNetProfit').textContent = formatNaira(netProfit); document.getElementById('plNetProfitCard').className = netProfit >= 0 ? 'stat-card profit profit-display' : 'stat-card loss profit-display'; }
    document.getElementById('addUserBtn').addEventListener('click', () => { document.getElementById('userForm').reset(); document.getElementById('userId').value = ''; document.getElementById('userModalTitle').textContent = 'Add New User'; showModal('userModal'); });
    window.editUser = (id) => { const user = db.users.find(u => u.id === id); if (!user) return; document.getElementById('userId').value = user.id; document.getElementById('userUsername').value = user.username; document.getElementById('userRole').value = user.role; document.getElementById('userPassword').value = ''; document.getElementById('userModalTitle').textContent = 'Edit User'; showModal('userModal'); }
    document.getElementById('userForm').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('userId').value; const username = document.getElementById('userUsername').value; const pass = document.getElementById('userPassword').value; const role = document.getElementById('userRole').value; if (id) { const user = db.users.find(u => u.id === id); Object.assign(user, {username, role}); if(pass) user.password = pass; } else { if (db.users.some(u => u.username === username)) { alert('Username taken.'); return; } db.users.push({ id: generateId(), username, password: pass, role }); } saveDatabase(); renderUserManagement(); closeModal('userModal'); });
    window.deleteUser = (id) => { if (confirm('Are you sure?')) { db.users = db.users.filter(u => u.id !== id); saveDatabase(); renderUserManagement(); } }
    document.getElementById('changePasswordForm').addEventListener('submit', (e) => { e.preventDefault(); const statusEl = document.getElementById('passwordChangeStatus'); const current = document.getElementById('currentPassword').value, newP = document.getElementById('newPassword').value; if(currentUser.password !== current) { statusEl.textContent = 'Current password incorrect.'; statusEl.style.color = 'red'; return; } if(newP !== document.getElementById('confirmNewPassword').value) { statusEl.textContent = 'Passwords do not match.'; statusEl.style.color = 'red'; return; } currentUser.password = newP; db.users.find(u => u.id === currentUser.id).password = newP; saveDatabase(); statusEl.textContent = 'Password changed!'; statusEl.style.color = 'green'; e.target.reset(); setTimeout(() => statusEl.textContent = '', 3000); });
    document.getElementById('backupDataBtn').addEventListener('click', () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' })); a.download = `BusinessManager_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); });
    document.getElementById('restoreDataBtn').addEventListener('click', () => { const file = document.getElementById('restoreDataInput').files[0]; if (!file || !confirm('WARNING: This will overwrite ALL data.')) return; const reader = new FileReader(); reader.onload = (event) => { try { const restoredDb = JSON.parse(event.target.result); if (restoredDb && restoredDb.users) { db = restoredDb; saveDatabase(); alert('Restore successful. You will be logged out.'); logout(); } else throw new Error(); } catch { alert('Invalid backup file.'); } }; reader.readAsText(file); });
    document.getElementById('downloadTransPdfBtn').addEventListener('click', () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const start = document.getElementById('transStartDate').value, end = document.getElementById('transEndDate').value; const allTrans = db.transactions.sort((a,b) => new Date(a.date) - new Date(b.date) || a.id.localeCompare(b.id)); const before = allTrans.filter(t => start && t.date < start); const opening = before.length > 0 ? before[before.length-1].balance : 0; const filtered = allTrans.filter(t => (!start || t.date >= start) && (!end || t.date <= end)); let runningBalance = opening; doc.setFontSize(18); doc.text("Capital Account Statement", 14, 16); doc.setFontSize(10); doc.text(`Period: ${start || 'Start'} to ${end || 'Today'}`, 14, 22); doc.text(`Opening Balance: ${formatNaira(opening)}`, 14, 28); doc.autoTable({ head: [['Date', 'Description', 'Debit', 'Credit', 'Balance']], body: filtered.map(t => { runningBalance -= t.debit; runningBalance += t.credit; return [t.date, t.description, t.debit > 0 ? formatNaira(t.debit) : '', t.credit > 0 ? formatNaira(t.credit) : '', formatNaira(runningBalance)]; }), startY: 35 }); if(filtered.length>0) doc.text(`Closing Balance: ${formatNaira(runningBalance)}`, 14, doc.lastAutoTable.finalY + 10); doc.save('Capital_Statement.pdf'); });
    document.getElementById('downloadTransCsvBtn').addEventListener('click', () => { const start = document.getElementById('transStartDate').value, end = document.getElementById('transEndDate').value; const allTrans = db.transactions.sort((a,b) => new Date(a.date) - new Date(b.date) || a.id.localeCompare(b.id)); const before = allTrans.filter(t => start && t.date < start); let runningBalance = before.length > 0 ? before[before.length-1].balance : 0; const filtered = allTrans.filter(t => (!start || t.date >= start) && (!end || t.date <= end)); let csv = "Date,Description,Debit,Credit,Balance\r\n"; filtered.forEach(t => { runningBalance -= t.debit; runningBalance += t.credit; csv += `${t.date},"${t.description.replace(/"/g, '""')}",${t.debit},${t.credit},${runningBalance}\r\n`; }); const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); a.download = 'Capital_Statement.csv'; a.click(); });


    // ===================== APPLICATION STARTUP =======================
    loadDatabase();
});
</script>
</body>
</html>
